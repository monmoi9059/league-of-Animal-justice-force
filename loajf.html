<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <title>League of Animal Justice Avenger Force: Operation Dumpster Fire</title>
    <style>
/* --- CSS --- */
body {
    background-color: #0d0d1a;
    color: #00ff41;
    font-family: 'Courier New', monospace;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    overflow: hidden; /* Prevent scrolling */
    height: 100vh;
}
h1 {
    font-size: 24px;
    margin-bottom: 5px;
    text-shadow: 0 0 10px #00ff41;
    display: none; /* Hide title to save space, maybe overlay it on menu */
}
#gameContainer {
    position: relative;
    width: 100%;
    height: 100%;
    /* Keep aspect ratio? Or fill? "Fit device screen" usually means fill. */
    /* Let's make it fill. */
    border: 0;
    box-shadow: none;
    background: #000;
}
canvas {
    display: block;
    width: 100%;
    height: 100%;
}
.controls {
    position: absolute;
    bottom: 10px;
    width: 100%;
    text-align: center;
    color: #fff;
    font-size: 12px;
    opacity: 0.5;
    pointer-events: none;
    z-index: 20;
}
/* ... existing styles for HUD/Overlays ... */
#gameUI {
    display: none;
    position: absolute;
    top: 15px; left: 20px; right: 20px;
    font-family: 'Courier New', monospace;
    font-size: 16px;
    font-weight: bold;
    pointer-events: none;
    justify-content: space-between;
    flex-wrap: wrap;
    z-index: 5;
}
.stat-box {
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    padding: 8px 15px;
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 20px;
    margin-bottom: 5px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    text-shadow: 1px 1px 0 #000;
    color: #fff;
}
#bossHealthContainer {
    display: none;
    position: absolute;
    bottom: 30px; left: 50%;
    transform: translateX(-50%);
    width: 600px; max-width: 90%; /* Responsive width */
    height: 20px;
    border: 2px solid #fff;
    background: #222;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 0 15px rgba(255, 0, 222, 0.5);
    z-index: 5;
}
#bossHealthBar {
    width: 100%; height: 100%;
    background: linear-gradient(90deg, #ff00de, #ff69b4);
    transition: width 0.2s;
}

.overlay-screen {
    display: none;
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85);
    backdrop-filter: blur(5px);
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    z-index: 10;
}

#menuOverlay {
    background: rgba(10, 10, 20, 0.95);
    justify-content: center; /* Centered menu */
    padding-bottom: 30px;
    z-index: 15;
    display: none;
}

#rosterOverlay {
    background: rgba(0, 0, 0, 0);
    backdrop-filter: none;
    justify-content: center;
    padding-bottom: 30px;
    z-index: 15;
    display: flex;
}

#levelCompleteOverlay {
    background: rgba(20, 40, 20, 0.95);
    z-index: 20;
    display: none;
}

button {
    background: linear-gradient(45deg, #ff00de, #a020f0);
    border: 2px solid #fff;
    color: white;
    padding: 15px 40px;
    font-size: 20px;
    font-weight: bold;
    cursor: pointer;
    text-transform: uppercase;
    box-shadow: 0 0 15px rgba(255, 0, 222, 0.6);
    border-radius: 5px;
    transition: transform 0.1s, box-shadow 0.1s;
    margin-top: 20px;
    pointer-events: auto;
}
button:hover { transform: scale(1.05); box-shadow: 0 0 25px rgba(255, 0, 222, 0.8); }

#errorOverlay {
    display: none;
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(50, 0, 0, 0.9);
    color: #ffcccc;
    font-family: monospace;
    padding: 20px;
    box-sizing: border-box;
    white-space: pre-wrap;
    overflow: auto;
    z-index: 9999;
}
#debugHUD {
    position: absolute;
    top: 5px; right: 5px;
    color: lime;
    font-size: 10px;
    background: rgba(0,0,0,0.5);
    padding: 2px;
    pointer-events: none;
    display: none; /* Hide unless needed */
}

/* --- TOUCH CONTROLS --- */
.touch-toggle {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 100;
    background: rgba(0, 0, 0, 0.5);
    color: white;
    border: 1px solid white;
    border-radius: 5px;
    padding: 10px;
    font-size: 24px;
    cursor: pointer;
    opacity: 0.7;
    margin-top: 0; /* Override generic button */
    box-shadow: none;
}

.touch-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none; /* Let clicks pass through empty space */
    z-index: 90;
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    padding: 20px;
    box-sizing: border-box;
}

.touch-btn {
    pointer-events: auto; /* Enable clicks on buttons */
    background: rgba(255, 255, 255, 0.15);
    border: 2px solid rgba(255, 255, 255, 0.5);
    color: white;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    font-size: 20px;
    font-weight: bold;
    user-select: none;
    touch-action: manipulation;
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 5px;
    padding: 0; /* Reset */
    backdrop-filter: blur(2px);
    transition: transform 0.1s, background 0.1s;
    box-shadow: none; /* Reset */
    text-shadow: 1px 1px 0 #000;
}

.touch-btn:active, .touch-btn.active {
    background: rgba(255, 255, 255, 0.4);
    transform: scale(0.95);
}

.touch-btn.toggle-btn.active {
    background: rgba(0, 255, 65, 0.5);
    border-color: #00ff41;
}

/* D-PAD */
.dpad-area {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 20px;
    margin-left: 20px;
}
.dpad-row {
    display: flex;
}
.dpad-spacer {
    width: 60px;
    height: 60px;
    margin: 5px;
}

/* ACTIONS */
.action-area {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    margin-bottom: 20px;
    margin-right: 20px;
}

.action-group-main {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 10px;
}
.action-group-sub {
    display: flex;
    justify-content: flex-end;
    flex-wrap: wrap;
    max-width: 280px; /* Force wrap if needed */
}

.action-btn.large {
    width: 80px;
    height: 80px;
    font-size: 24px;
    background: rgba(255, 0, 222, 0.2);
    border-color: rgba(255, 0, 222, 0.5);
}

/* LOBBY */
.lobby-slot {
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid #555;
    border-radius: 10px;
    padding: 15px;
    width: 150px;
    text-align: center;
    transition: border-color 0.2s, background 0.2s;
}
.lobby-slot h3 {
    margin: 0 0 10px 0;
    font-size: 16px;
    color: #aaa;
}
.lobby-status {
    font-size: 14px;
    font-weight: bold;
    min-height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    white-space: pre-wrap;
}

/* Landscape adjustments for mobile */
@media (max-height: 500px) {
    .touch-btn {
        width: 50px;
        height: 50px;
        font-size: 16px;
    }
    .touch-btn.large {
        width: 70px;
        height: 70px;
    }
    .dpad-spacer {
        width: 50px;
        height: 50px;
    }
    .action-area {
        margin-right: 50px; /* Give thumb space */
    }
    .dpad-area {
        margin-left: 50px;
    }
    .lobby-slot {
        width: 100px;
        padding: 10px;
    }
}

</style>
</head>
<body>

    <div id="gameContainer">
        <!-- Canvas size will be set by JS -->
        <canvas id="gameCanvas"></canvas>
        <div id="errorOverlay"></div>
        <div id="debugHUD">Initializing...</div>

        <!-- HUD -->
        <div id="gameUI">
            <div class="stat-box">HERO: <span id="charName" style="color:#00ff41">IRON MUTT</span></div>
            <div class="stat-box">HP: <span id="healthDisplay" style="color:#ff00de">‚ù§‚ù§‚ù§</span></div>
            <div class="stat-box">LIVES: <span id="livesDisplay" style="color:yellow">3</span></div>
            <div class="stat-box">RESCUES: <span id="rescueDisplay">0</span></div>
            <div class="stat-box">SCORE: <span id="scoreDisplay">0</span></div>
            <div class="stat-box">LEVEL: <span id="levelDisplay">1</span></div>
        </div>

        <div id="bossHealthContainer">
            <div id="bossHealthBar"></div>
        </div>

        <!-- MAIN MENU -->
        <div id="menuOverlay" class="overlay-screen">
             <!-- Title in Menu -->
             <h1 style="font-size: 32px; color: #00ff41; margin-bottom: 40px; text-align: center; max-width: 80%;">
                LEAGUE OF ANIMAL JUSTICE<br>AVENGER FORCE
            </h1>
            <button onclick="window.enterLobby()">DEPLOY SQUAD</button>
            <button onclick="window.viewRoster()">VIEW TEAM</button>
        </div>

        <!-- LOBBY MENU -->
        <div id="lobbyOverlay" class="overlay-screen">
            <h2 style="color: #00ff41; font-size: 30px; margin-bottom: 20px;">SQUAD ASSEMBLY</h2>
            <div id="lobbyStatusContainer" style="display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; justify-content: center;">
                <div class="lobby-slot">
                    <h3>PLAYER 1</h3>
                    <div id="lobbyStatus1" class="lobby-status">PRESS SPACE / A</div>
                </div>
                <div class="lobby-slot">
                    <h3>PLAYER 2</h3>
                    <div id="lobbyStatus2" class="lobby-status">PRESS SPACE / A</div>
                </div>
                <div class="lobby-slot">
                    <h3>PLAYER 3</h3>
                    <div id="lobbyStatus3" class="lobby-status">PRESS SPACE / A</div>
                </div>
                <div class="lobby-slot">
                    <h3>PLAYER 4</h3>
                    <div id="lobbyStatus4" class="lobby-status">PRESS SPACE / A</div>
                </div>
            </div>
            <div id="lobbyMessage" style="color: #fff; margin-bottom: 20px; min-height: 24px;">WAITING FOR PLAYERS...</div>
            <button id="lobbyStartBtn" onclick="window.startGame()" style="display: none;">START MISSION</button>
            <button onclick="window.returnToMenu()" style="margin-top: 10px; font-size: 16px; padding: 10px 20px; background: none; border: 1px solid #555;">CANCEL</button>
        </div>

        <!-- ROSTER MENU -->
        <div id="rosterOverlay" class="overlay-screen">
            <button onclick="window.returnToMenu()" style="position: absolute; bottom: 30px;">BACK</button>
        </div>

        <!-- LEVEL COMPLETE -->
        <div id="levelCompleteOverlay" class="overlay-screen">
            <h2 style="color: gold; font-size: 40px; margin-bottom: 20px;">AREA SECURED</h2>
            <div style="font-size: 20px; color: #fff; line-height: 1.6;">
                <p>KILLS: <span id="lcKills" style="color: red">0</span></p>
                <p>RESCUES: <span id="lcRescues" style="color: #00ff41">0</span></p>
                <p>TIME BONUS: <span id="lcTime" style="color: yellow">0</span></p>
            </div>
            <button onclick="window.nextLevel()">NEXT MISSION</button>
        </div>

        <!-- GAME OVER / WIN -->
        <div id="gameOverOverlay" class="overlay-screen">
            <h2 id="ovTitle" style="font-size: 50px; color: #00ff41; margin-bottom: 10px;">MISSION FAILED</h2>
            <p id="ovMsg" style="margin-bottom: 30px; font-size: 20px;">The HOA has won.</p>
            <button onclick="window.returnToBase()">RETURN TO BASE</button>
        </div>

        <div class="controls">
            ARROWS/WASD: Move | SPACE: Jump | SHIFT: Sprint | Z: Shoot | X: Special | C: 2nd Attack | DOWN+Z: Down Attack | F: Flex
        </div>

        <!-- Touch Controls -->
        <button id="controlsToggle" class="touch-toggle">üéÆ</button>
        <button id="soundToggle" class="touch-toggle" style="right: 70px;">üîä</button>

        <div id="touchControls" class="touch-overlay" style="display: none;">
            <div class="dpad-area">
                <div class="dpad-row">
                    <button id="btnUp" class="touch-btn dpad-btn">‚ñ≤</button>
                </div>
                <div class="dpad-row">
                    <button id="btnLeft" class="touch-btn dpad-btn">‚óÄ</button>
                    <div class="dpad-spacer"></div>
                    <button id="btnRight" class="touch-btn dpad-btn">‚ñ∂</button>
                </div>
                <div class="dpad-row">
                    <button id="btnDown" class="touch-btn dpad-btn">‚ñº</button>
                </div>
            </div>

            <div class="action-area">
                <div class="action-group-main">
                    <button id="btnShoot" class="touch-btn action-btn large">Z</button>
                    <button id="btnJump" class="touch-btn action-btn large">SPACE</button>
                </div>
                <div class="action-group-sub">
                    <button id="btnSpecial" class="touch-btn action-btn">X</button>
                    <button id="btnSecondary" class="touch-btn action-btn">C</button>
                    <button id="btnFlex" class="touch-btn action-btn">F</button>
                    <button id="btnSprint" class="touch-btn action-btn toggle-btn">RUN</button>
                </div>
            </div>
        </div>
    </div>


<script>
!function(){"use strict";const t=document.getElementById("gameCanvas"),e=t.getContext("2d"),i=document.getElementById("debugHUD"),l=40,s=.6,h=400,a=60,o=1e3/60,n="#5d4037",r="#8d6e63",c="#4caf50",y="#546e7a",p="#78909c",f="#1e3c72",d="#2a5298",m="#d35400",u=[{id:"pug",name:"IRON MUTT",type:"dog_flat",cSkin:"#f3cf98",cDark:"#3b302a",cSuit:"#b0c4de",pType:"laser",pColor:"#a020f0"},{id:"raccoon",name:"CPT TRASH",type:"raccoon",cSkin:"#888",cDark:"#444",cSuit:"#555",pType:"boomerang",pColor:"#aaa"},{id:"cat",name:"BAT CAT",type:"cat",cSkin:"#222",cDark:"#000",cSuit:"#111",pType:"boomerang",pColor:"#ff69b4"},{id:"corgi",name:"THOR-GI",type:"dog_pointy",cSkin:"#E3C099",cDark:"#FFF",cSuit:"#333",pType:"boomerang",pColor:"#00FFFF"},{id:"hulk",name:"HULK-POODLE",type:"poodle",cSkin:"#00FF00",cDark:"#006400",cSuit:"#800080",pType:"melee_smash",pColor:"#00FF00"},{id:"spider",name:"SPIDER-PIG",type:"pig",cSkin:"#FFC0CB",cDark:"#FF69B4",cSuit:"#FF0000",pType:"gun",pColor:"#FFF"},{id:"wolvie",name:"WOLVER-WEENIE",type:"dog_long",cSkin:"#8B4513",cDark:"#000",cSuit:"#FFFF00",pType:"melee_slash",pColor:"#C0C0C0"},{id:"dead",name:"DEAD-POODLE",type:"poodle",cSkin:"#FF0000",cDark:"#000",cSuit:"#333",pType:"gun",pColor:"#FF0000"},{id:"cap",name:"CAPTAIN EAGLE",type:"bird",cSkin:"#FFF",cDark:"#A52A2A",cSuit:"#0000FF",pType:"boomerang",pColor:"#FFF"},{id:"ironmouse",name:"IRON-MOUSE",type:"rodent",cSkin:"#808080",cDark:"#404040",cSuit:"#FF0000",pType:"laser",pColor:"#FFFF00"},{id:"widow",name:"BLACK WIDOW-PUG",type:"dog_flat",cSkin:"#000",cDark:"#111",cSuit:"#222",pType:"gun",pColor:"#00FFFF"},{id:"hawkeye",name:"HAWK-HEDGEHOG",type:"hedgehog",cSkin:"#D2B48C",cDark:"#8B4513",cSuit:"#800080",pType:"grenade",pColor:"#DDD"},{id:"strange",name:"DR STRANGE-CAT",type:"cat",cSkin:"#444",cDark:"#222",cSuit:"#0000FF",pType:"magic",pColor:"#FFA500"},{id:"panther",name:"BLACK PANTHER",type:"cat",cSkin:"#111",cDark:"#000",cSuit:"#222",pType:"melee_slash",pColor:"#800080"},{id:"ant",name:"ANT-EATER-MAN",type:"anteater",cSkin:"#808080",cDark:"#404040",cSuit:"#FF0000",pType:"melee_smash",pColor:"#FF0000"},{id:"starlord",name:"STAR-LORD-FOX",type:"fox",cSkin:"#FF8C00",cDark:"#8B0000",cSuit:"#8B4513",pType:"laser",pColor:"#FFFF00"},{id:"gamora",name:"GAMORA-GECKO",type:"lizard",cSkin:"#00FF00",cDark:"#006400",cSuit:"#000",pType:"melee_slash",pColor:"#00FF00"},{id:"drax",name:"DRAX-BULLDOG",type:"dog_flat",cSkin:"#008000",cDark:"#FF0000",cSuit:"#000080",pType:"melee_slash",pColor:"#CCC"},{id:"groot",name:"GROOT-BARK",type:"tree",cSkin:"#8B4513",cDark:"#A0522D",cSuit:"#654321",pType:"melee_smash",pColor:"#8B4513"},{id:"rocket",name:"ROCKET-RABBIT",type:"rabbit",cSkin:"#A9A9A9",cDark:"#696969",cSuit:"#FF4500",pType:"grenade",pColor:"#FF4500"},{id:"vision",name:"VISION-ZEBRA",type:"horse",cSkin:"#FFC0CB",cDark:"#008000",cSuit:"#FFFF00",pType:"laser",pColor:"#FFFF00"},{id:"scarlet",name:"SCARLET-SKUNK",type:"skunk",cSkin:"#000",cDark:"#FFF",cSuit:"#FF0000",pType:"magic",pColor:"#FF0000"},{id:"quick",name:"QUICK-CHEETAH",type:"cat",cSkin:"#D3D3D3",cDark:"#A9A9A9",cSuit:"#87CEEB",pType:"melee_slash",pColor:"#87CEEB"},{id:"winter",name:"WINTER-WOLF",type:"dog_pointy",cSkin:"#FFF",cDark:"#808080",cSuit:"#000",pType:"gun",pColor:"#C0C0C0"},{id:"falcon",name:"FALCON-PIGEON",type:"bird",cSkin:"#808080",cDark:"#696969",cSuit:"#FF0000",pType:"gun",pColor:"#CCC"},{id:"war",name:"WAR-RHINO",type:"rhino",cSkin:"#708090",cDark:"#2F4F4F",cSuit:"#000",pType:"grenade",pColor:"#999"},{id:"dare",name:"DAREDEVIL-DOG",type:"dog_pointy",cSkin:"#B22222",cDark:"#800000",cSuit:"#FF0000",pType:"melee_slash",pColor:"#FF0000"},{id:"punish",name:"PUNISHER-PENGUIN",type:"bird",cSkin:"#000",cDark:"#FFF",cSuit:"#000",pType:"spread",pColor:"#FFF"},{id:"shang",name:"SHANG-CHI-PANDA",type:"bear",cSkin:"#000",cDark:"#FFF",cSuit:"#FF0000",pType:"melee_smash",pColor:"#FFD700"},{id:"eternal",name:"ETERNAL-ELEPHANT",type:"elephant",cSkin:"#808080",cDark:"#696969",cSuit:"#FFD700",pType:"magic",pColor:"#FFD700"},{id:"moon",name:"MOON-OWL",type:"bird",cSkin:"#FFF",cDark:"#EEE",cSuit:"#DDD",pType:"boomerang",pColor:"#FFF"},{id:"shehulk",name:"SHE-HULK-HAMSTER",type:"rodent",cSkin:"#32CD32",cDark:"#006400",cSuit:"#800080",pType:"melee_smash",pColor:"#00FF00"},{id:"ghost",name:"GHOST-GOAT",type:"goat",cSkin:"#FFF",cDark:"#FF4500",cSuit:"#000",pType:"melee_slash",pColor:"#FF4500"},{id:"unicorncyborg",name:"UNICORN-CYBORG",type:"robot",cSkin:"#6495ED",cDark:"#FFEBCD",cSuit:"#2E8B57",pType:"lightning",pColor:"#FFE4C4"},{id:"creaturehedgehog",name:"CREATURE-HEDGEHOG",type:"hedgehog",cSkin:"#00FF00",cDark:"#DAA520",cSuit:"#008B8B",pType:"melee_smash",pColor:"#40E0D0"},{id:"storestump",name:"STORE-STUMP",type:"tree",cSkin:"#006400",cDark:"#6495ED",cSuit:"#000000",pType:"boomerang",pColor:"#FFDEAD"},{id:"galaxygod",name:"GALAXY-GOD",type:"human",cSkin:"#F0F8FF",cDark:"#BDB76B",cSuit:"#DAA520",pType:"shuriken",pColor:"#FAF0E6"},{id:"wraithhouse",name:"WRAITH-HOUSE",type:"stone",cSkin:"#800000",cDark:"#98FB98",cSuit:"#000080",pType:"acid_spit",pColor:"#5F9EA0"},{id:"ninjakangaroo",name:"NINJA-KANGAROO",type:"rabbit",cSkin:"#DCDCDC",cDark:"#F0FFF0",cSuit:"#8FBC8F",pType:"card_throw",pColor:"#808080"},{id:"devilcastle",name:"DEVIL-CASTLE",type:"stone",cSkin:"#48D1CC",cDark:"#008000",cSuit:"#0000FF",pType:"water_gun",pColor:"#7CFC00"},{id:"aquaalpaca",name:"AQUA-ALPACA",type:"horse",cSkin:"#FFE4E1",cDark:"#FFDEAD",cSuit:"#F5DEB3",pType:"rocket",pColor:"#FAFAD2"},{id:"makeupgate",name:"MAKEUP-GATE",type:"stone",cSkin:"#FFDEAD",cDark:"#F0F8FF",cSuit:"#D2B48C",pType:"fireball",pColor:"#008000"},{id:"alienboulder",name:"ALIEN-BOULDER",type:"stone",cSkin:"#808080",cDark:"#FAEBD7",cSuit:"#006400",pType:"ice_beam",pColor:"#00BFFF"},{id:"skeletonram",name:"SKELETON-RAM",type:"goat",cSkin:"#006400",cDark:"#800080",cSuit:"#00FA9A",pType:"gun",pColor:"#B0C4DE"},{id:"aquariumforest",name:"AQUARIUM-FOREST",type:"tree",cSkin:"#FFFAFA",cDark:"#1E90FF",cSuit:"#556B2F",pType:"laser",pColor:"#F5F5DC"},{id:"darklog",name:"DARK-LOG",type:"tree",cSkin:"#F0E68C",cDark:"#00FFFF",cSuit:"#00CED1",pType:"water_gun",pColor:"#FFFFFF"},{id:"factoryskeleton",name:"FACTORY-SKELETON",type:"skeleton",cSkin:"#FDF5E6",cDark:"#FFFACD",cSuit:"#556B2F",pType:"acid_spit",pColor:"#F5F5F5"},{id:"defenderroof",name:"DEFENDER-ROOF",type:"stone",cSkin:"#A52A2A",cDark:"#0000FF",cSuit:"#000000",pType:"boomerang",pColor:"#D2691E"},{id:"robbereagle",name:"ROBBER-EAGLE",type:"bird",cSkin:"#F8F8FF",cDark:"#4682B4",cSuit:"#3CB371",pType:"lightning",pColor:"#20B2AA"},{id:"professorskunk",name:"PROFESSOR-SKUNK",type:"skunk",cSkin:"#F4A460",cDark:"#800000",cSuit:"#2F4F4F",pType:"rocket",pColor:"#800000"},{id:"earthbuffalo",name:"EARTH-BUFFALO",type:"cow",cSkin:"#7FFF00",cDark:"#4169E1",cSuit:"#FFFF00",pType:"fireball",pColor:"#00FFFF"},{id:"ogreguinea",name:"OGRE-GUINEA",type:"rodent",cSkin:"#FFE4C4",cDark:"#708090",cSuit:"#2F4F4F",pType:"gun",pColor:"#00CED1"},{id:"artistalien",name:"ARTIST-ALIEN",type:"alien",cSkin:"#FFEBCD",cDark:"#ADFF2F",cSuit:"#0000CD",pType:"ice_beam",pColor:"#F5F5F5"},{id:"firedonkey",name:"FIRE-DONKEY",type:"horse",cSkin:"#191970",cDark:"#800000",cSuit:"#2F4F4F",pType:"water_gun",pColor:"#EEE8AA"},{id:"fighterhawk",name:"FIGHTER-HAWK",type:"bird",cSkin:"#F8F8FF",cDark:"#006400",cSuit:"#F0E68C",pType:"gun",pColor:"#F0FFFF"},{id:"trollpeacock",name:"TROLL-PEACOCK",type:"bird",cSkin:"#8FBC8F",cDark:"#40E0D0",cSuit:"#00FF7F",pType:"gun",pColor:"#FFF5EE"},{id:"detectivemonkey",name:"DETECTIVE-MONKEY",type:"monkey",cSkin:"#000080",cDark:"#F5F5F5",cSuit:"#F0FFFF",pType:"laser",pColor:"#FAEBD7"},{id:"homelizard",name:"HOME-LIZARD",type:"lizard",cSkin:"#808000",cDark:"#CD853F",cSuit:"#BC8F8F",pType:"melee_slash",pColor:"#FFF8DC"},{id:"headsmanshark",name:"HEADSMAN-SHARK",type:"fish",cSkin:"#4682B4",cDark:"#00FF7F",cSuit:"#FFE4C4",pType:"melee_slash",pColor:"#D3D3D3"},{id:"caferaven",name:"CAFE-RAVEN",type:"bird",cSkin:"#008B8B",cDark:"#90EE90",cSuit:"#90EE90",pType:"rocket",pColor:"#FFA500"},{id:"phoenixdemon",name:"PHOENIX-DEMON",type:"goat",cSkin:"#EEE8AA",cDark:"#7FFF00",cSuit:"#6B8E23",pType:"grenade",pColor:"#FFE4C4"},{id:"alienlion",name:"ALIEN-LION",type:"cat",cSkin:"#87CEFA",cDark:"#008B8B",cSuit:"#708090",pType:"melee_slash",pColor:"#00FF00"},{id:"paintervillain",name:"PAINTER-VILLAIN",type:"human",cSkin:"#F0E68C",cDark:"#3CB371",cSuit:"#66CDAA",pType:"laser",pColor:"#F0F8FF"},{id:"mageslime",name:"MAGE-SLIME",type:"alien",cSkin:"#00FA9A",cDark:"#BDB76B",cSuit:"#8FBC8F",pType:"melee_smash",pColor:"#008080"},{id:"journalistceiling",name:"JOURNALIST-CEILING",type:"stone",cSkin:"#FFDAB9",cDark:"#A0522D",cSuit:"#228B22",pType:"melee_slash",pColor:"#800000"},{id:"bakerhamster",name:"BAKER-HAMSTER",type:"rodent",cSkin:"#808000",cDark:"#00FFFF",cSuit:"#2E8B57",pType:"fireball",pColor:"#87CEEB"},{id:"zombiefish",name:"ZOMBIE-FISH",type:"fish",cSkin:"#F0F8FF",cDark:"#D2691E",cSuit:"#008000",pType:"ice_beam",pColor:"#F0FFFF"},{id:"chefdeer",name:"CHEF-DEER",type:"goat",cSkin:"#800000",cDark:"#EEE8AA",cSuit:"#FFE4C4",pType:"rocket",pColor:"#000080"},{id:"resortstone",name:"RESORT-STONE",type:"stone",cSkin:"#808080",cDark:"#FAFAD2",cSuit:"#8FBC8F",pType:"boomerang",pColor:"#00FF7F"},{id:"hospitalchipmunk",name:"HOSPITAL-CHIPMUNK",type:"rodent",cSkin:"#FFEFD5",cDark:"#FFFACD",cSuit:"#008B8B",pType:"card_throw",pColor:"#5F9EA0"},{id:"mutantkoala",name:"MUTANT-KOALA",type:"bear",cSkin:"#4682B4",cDark:"#DCDCDC",cSuit:"#008000",pType:"laser",pColor:"#696969"},{id:"directordirt",name:"DIRECTOR-DIRT",type:"stone",cSkin:"#00FA9A",cDark:"#F5FFFA",cSuit:"#FFFAFA",pType:"spread",pColor:"#008080"},{id:"spectrebison",name:"SPECTRE-BISON",type:"cow",cSkin:"#FFF0F5",cDark:"#FFFFF0",cSuit:"#9ACD32",pType:"card_throw",pColor:"#FFDEAD"},{id:"convictchicken",name:"CONVICT-CHICKEN",type:"duck",cSkin:"#D2691E",cDark:"#FFEBCD",cSuit:"#808080",pType:"grenade",pColor:"#FFFF00"},{id:"innmud",name:"INN-MUD",type:"stone",cSkin:"#FAF0E6",cDark:"#008080",cSuit:"#C0C0C0",pType:"card_throw",pColor:"#9ACD32"},{id:"killerdonkey",name:"KILLER-DONKEY",type:"horse",cSkin:"#7FFF00",cDark:"#F0FFFF",cSuit:"#FFFACD",pType:"grenade",pColor:"#708090"},{id:"professorkangaroo",name:"PROFESSOR-KANGAROO",type:"rabbit",cSkin:"#FFE4C4",cDark:"#C0C0C0",cSuit:"#000000",pType:"spread",pColor:"#40E0D0"},{id:"paramedicpeacock",name:"PARAMEDIC-PEACOCK",type:"bird",cSkin:"#00FF00",cDark:"#FFF0F5",cSuit:"#0000FF",pType:"laser",pColor:"#FDF5E6"},{id:"restaurantwolf",name:"RESTAURANT-WOLF",type:"wolf",cSkin:"#191970",cDark:"#FFE4C4",cSuit:"#B8860B",pType:"ice_beam",pColor:"#E6E6FA"},{id:"knightsheep",name:"KNIGHT-SHEEP",type:"goat",cSkin:"#D2691E",cDark:"#B8860B",cSuit:"#F0FFF0",pType:"acid_spit",pColor:"#000080"},{id:"ranchwombat",name:"RANCH-WOMBAT",type:"rodent",cSkin:"#708090",cDark:"#D3D3D3",cSuit:"#000080",pType:"melee_slash",pColor:"#FFE4C4"},{id:"murdererforest",name:"MURDERER-FOREST",type:"tree",cSkin:"#006400",cDark:"#F8F8FF",cSuit:"#4682B4",pType:"spread",pColor:"#008B8B"},{id:"nightllama",name:"NIGHT-LLAMA",type:"horse",cSkin:"#808000",cDark:"#008000",cSuit:"#FFFF00",pType:"melee_smash",pColor:"#FFFF00"},{id:"musicianturkey",name:"MUSICIAN-TURKEY",type:"duck",cSkin:"#228B22",cDark:"#DEB887",cSuit:"#FFFAF0",pType:"spread",pColor:"#FF0000"},{id:"oozecrow",name:"OOZE-CROW",type:"bird",cSkin:"#ADD8E6",cDark:"#228B22",cSuit:"#778899",pType:"lightning",pColor:"#9ACD32"},{id:"lordblob",name:"LORD-BLOB",type:"alien",cSkin:"#008B8B",cDark:"#F8F8FF",cSuit:"#F0E68C",pType:"water_gun",pColor:"#800080"},{id:"shadowpanda",name:"SHADOW-PANDA",type:"bear",cSkin:"#6495ED",cDark:"#008080",cSuit:"#808080",pType:"melee_smash",pColor:"#F0F8FF"},{id:"spyboulder",name:"SPY-BOULDER",type:"stone",cSkin:"#7FFFD4",cDark:"#ADD8E6",cSuit:"#E6E6FA",pType:"card_throw",pColor:"#98FB98"},{id:"stylistearth",name:"STYLIST-EARTH",type:"stone",cSkin:"#006400",cDark:"#F0E68C",cSuit:"#00CED1",pType:"card_throw",pColor:"#90EE90"},{id:"sparock",name:"SPA-ROCK",type:"stone",cSkin:"#000000",cDark:"#DEB887",cSuit:"#000080",pType:"lightning",pColor:"#0000FF"},{id:"farmpig",name:"FARM-PIG",type:"pig",cSkin:"#696969",cDark:"#696969",cSuit:"#FFF5EE",pType:"lightning",pColor:"#00FFFF"},{id:"guardbrick",name:"GUARD-BRICK",type:"stone",cSkin:"#66CDAA",cDark:"#C0C0C0",cSuit:"#40E0D0",pType:"shuriken",pColor:"#008B8B"},{id:"sunpegasus",name:"SUN-PEGASUS",type:"horse",cSkin:"#BDB76B",cDark:"#FFFAFA",cSuit:"#008000",pType:"lightning",pColor:"#0000CD"},{id:"shopstone",name:"SHOP-STONE",type:"stone",cSkin:"#F0FFFF",cDark:"#A0522D",cSuit:"#FFEFD5",pType:"fireball",pColor:"#E6E6FA"},{id:"princemonster",name:"PRINCE-MONSTER",type:"alien",cSkin:"#000080",cDark:"#808000",cSuit:"#FFDEAD",pType:"gun",pColor:"#FFDEAD"},{id:"directorreindeer",name:"DIRECTOR-REINDEER",type:"goat",cSkin:"#8FBC8F",cDark:"#A52A2A",cSuit:"#00FA9A",pType:"gun",pColor:"#B0C4DE"},{id:"policecroc",name:"POLICE-CROC",type:"croc",cSkin:"#228B22",cDark:"#006400",cSuit:"#A52A2A",pType:"shuriken",pColor:"#A0522D"},{id:"composerfrog",name:"COMPOSER-FROG",type:"frog",cSkin:"#32CD32",cDark:"#006400",cSuit:"#9ACD32",pType:"boomerang",pColor:"#FFDEAD"},{id:"nunturtle",name:"NUN-TURTLE",type:"turtle",cSkin:"#2E8B57",cDark:"#006400",cSuit:"#FFFAFA",pType:"melee_slash",pColor:"#FFE4E1"},{id:"homepumpkin",name:"HOME-PUMPKIN",type:"pumpkin",cSkin:"#FFA500",cDark:"#006400",cSuit:"#D3D3D3",pType:"ice_beam",pColor:"#ADFF2F"}],g={screen:"MENU",running:!1,score:0,cameraX:0,cameraY:0,zoom:1,shake:0,frame:0,checkpointsHit:0,rescues:0,lives:3,unlockedCount:1,globalUnlocked:1,spawnPoint:{x:100,y:0},bossActive:!1,hitStop:0,currentLevel:1,levelData:{biome:"forest",difficulty:1,width:400,height:60},slowMo:1,levelCompleteStats:{kills:0,rescues:0,time:0}};let F=[],S=[],x=[],k=[],T=[],w=[],v=null,b=0,E=[{},{},{},{}];function C(t){S=t}function D(t){x=t}function A(t){k=t}function M(t){T=t}function P(t){w=t}function I(t){v=t}function R(t){b=t}function B(){let t=w&&w[0];if(!t)return;let e="‚ù§".repeat(Math.max(0,t.health));if(w.length>1){e+=" | ";for(let t=1;t<w.length;t++)e+="P"+(t+1)+":"+"‚ù§".repeat(Math.max(0,w[t].health))+" "}document.getElementById("healthDisplay").innerText=e,document.getElementById("scoreDisplay").innerText=g.score,document.getElementById("rescueDisplay").innerText=g.rescues,document.getElementById("livesDisplay").innerText=g.lives,document.getElementById("levelDisplay").innerText=g.currentLevel;let i=t.charData?t.charData.name:"UNKNOWN";w.length>1&&(i+=" + TEAM"),document.getElementById("charName").innerText=i,t.charData&&(document.getElementById("charName").style.color=t.charData.cSkin)}function O(){g.running=!1,g.levelCompleteStats.kills=0;let t=Math.floor((g.score-500*g.rescues)/100);t<0&&(t=0),document.getElementById("lcKills").innerText=t,document.getElementById("lcRescues").innerText=g.rescues,document.getElementById("lcTime").innerText=Math.floor((1e4-g.frame)/60),document.getElementById("levelCompleteOverlay").style.display="flex"}const L=new class{constructor(){this.ctx=null,this.masterGain=null,this.muted=!1,this.volume=.3,this.initialized=!1}init(){if(!this.initialized)try{const t=window.AudioContext||window.webkitAudioContext;this.ctx=new t,this.masterGain=this.ctx.createGain(),this.masterGain.connect(this.ctx.destination),this.masterGain.gain.setValueAtTime(this.muted?0:this.volume,this.ctx.currentTime),this.initialized=!0,console.log("Audio Context Initialized")}catch(t){console.error("Web Audio API not supported",t)}}toggleMute(){return this.muted=!this.muted,this.masterGain&&this.ctx&&this.masterGain.gain.setValueAtTime(this.muted?0:this.volume,this.ctx.currentTime),this.muted}play(t){if(this.initialized||this.init(),this.muted||!this.ctx)return;"suspended"===this.ctx.state&&this.ctx.resume().catch(t=>console.error(t));const e=this.ctx.currentTime,i=this.ctx.createOscillator(),l=this.ctx.createGain();switch(i.connect(l),l.connect(this.masterGain),t){case"jump":i.type="square",i.frequency.setValueAtTime(150,e),i.frequency.exponentialRampToValueAtTime(600,e+.1),l.gain.setValueAtTime(.1,e),l.gain.exponentialRampToValueAtTime(.01,e+.1),i.start(e),i.stop(e+.1);break;case"shoot":i.type="square",i.frequency.setValueAtTime(800,e),i.frequency.exponentialRampToValueAtTime(100,e+.15),l.gain.setValueAtTime(.1,e),l.gain.exponentialRampToValueAtTime(.01,e+.15),i.start(e),i.stop(e+.15);break;case"enemy_shoot":i.type="triangle",i.frequency.setValueAtTime(400,e),i.frequency.exponentialRampToValueAtTime(100,e+.2),l.gain.setValueAtTime(.1,e),l.gain.exponentialRampToValueAtTime(.01,e+.2),i.start(e),i.stop(e+.2);break;case"explosion":i.type="sawtooth",i.frequency.setValueAtTime(100,e),i.frequency.exponentialRampToValueAtTime(10,e+.4);const t=this.ctx.createOscillator();t.type="square",t.frequency.setValueAtTime(80,e),t.frequency.exponentialRampToValueAtTime(5,e+.4),t.connect(l),t.start(e),t.stop(e+.4),l.gain.setValueAtTime(.3,e),l.gain.exponentialRampToValueAtTime(.01,e+.4),i.start(e),i.stop(e+.4);break;case"powerup":i.type="sine",i.frequency.setValueAtTime(440,e),i.frequency.setValueAtTime(554,e+.1),i.frequency.setValueAtTime(659,e+.2),i.frequency.setValueAtTime(880,e+.3),l.gain.setValueAtTime(.1,e),l.gain.linearRampToValueAtTime(.1,e+.3),l.gain.exponentialRampToValueAtTime(.01,e+.6),i.start(e),i.stop(e+.6);break;case"hurt":i.type="sawtooth",i.frequency.setValueAtTime(200,e),i.frequency.linearRampToValueAtTime(50,e+.2),l.gain.setValueAtTime(.1,e),l.gain.exponentialRampToValueAtTime(.01,e+.2),i.start(e),i.stop(e+.2);break;case"brick_break":i.type="square",i.frequency.setValueAtTime(100,e),i.frequency.exponentialRampToValueAtTime(20,e+.1),l.gain.setValueAtTime(.2,e),l.gain.exponentialRampToValueAtTime(.01,e+.1),i.start(e),i.stop(e+.1)}}},_=[null,null,null,null];let N=[{},{},{},{}];function U(){try{const t=new Uint32Array(1);let e=window.crypto||window.msCrypto;return e&&e.getRandomValues?(e.getRandomValues(t),t[0]/4294967296):Math.random()}catch(t){return Math.random()}}function H(t,e,i,l,s,h,a,o){return s<t+i&&s+a>t&&h<e+l&&h+o>e}function G(t,e){return!(!t||!e)&&H(t.x,t.y,t.w,t.h,e.x,e.y,e.w,e.h)}class V{constructor(t,e,i){this.x=t,this.y=e,this.color=i,this.life=1,this.vx=8*(U()-.5),this.vy=8*(U()-.5),this.size=6*U()+3}update(){this.x+=this.vx,this.y+=this.vy,this.vy+=.4,this.life-=.05}draw(t){t.save(),t.fillStyle=this.color,t.globalAlpha=Math.max(0,this.life),t.beginPath(),t.arc(this.x,this.y,this.size,0,2*Math.PI),t.fill(),t.restore()}}class K{constructor(t,e,i){this.x=t,this.y=e,this.color=i,this.vx=8*(U()-.5),this.vy=5*-U()-2,this.life=120,this.angle=U(),this.rotSpeed=.5*(U()-.5),this.size=8*U()+4}update(){this.x+=this.vx,this.y+=this.vy,this.vy+=.5,this.angle+=this.rotSpeed,this.life--;let t=Math.floor(this.y/l),e=Math.floor(this.x/l);t>=0&&t<a&&e>=0&&e<h&&F[t]&&F[t][e]&&0!==F[t][e].type&&(this.vy=0,this.vx*=.8,this.rotSpeed*=.8,this.y=t*l-2)}draw(t){t.save(),t.translate(this.x,this.y),t.rotate(this.angle),t.fillStyle=this.color,t.fillRect(-this.size/2,-this.size/2,this.size,this.size),t.restore()}}function W(t,e,i,l="white"){k.push({x:t,y:e,text:i,life:60,vy:-2,color:l})}function Y(t,e,i,l=1){for(let s=0;s<8*l;s++)x.push(new V(t,e,i))}function z(t,e,i){for(let l=0;l<6;l++){let l=new K(t+20*U(),e+20*U(),i);l.size=4*U()+2,T.push(l)}}function q(t,e,i){for(let s=e-i;s<=e+i;s++)for(let e=t-i;e<=t+i;e++)s>=0&&s<a&&e>=0&&e<h&&F[s]&&F[s][e]&&1===F[s][e].type&&(z(e*l,s*l,r),F[s][e]={type:0},L&&L.play("brick_break"))}function X(t){g.shake=t,t>10&&(g.hitStop=3)}function $(t,e,i,s){if(Y(t,e,"orange",i),L&&L.play("explosion"),q(Math.floor(t/l),Math.floor(e/l),i),w)for(let h of w)if(h.health>0){Math.sqrt(Math.pow(h.x-t,2)+Math.pow(h.y-e,2))<i*l+20&&h.takeDamage(s)}for(let h=0;h<S.length;h++){let a=S[h];if(a.hp>0){Math.sqrt(Math.pow(a.x-t,2)+Math.pow(a.y-e,2))<i*l+20&&a.takeDamage&&a.takeDamage(s,t)}}}function j(t,e,i,l,s,h){l<2*h&&(h=l/2),s<2*h&&(h=s/2),t.beginPath(),t.moveTo(e+h,i),t.arcTo(e+l,i,e+l,i+s,h),t.arcTo(e+l,i+s,e,i+s,h),t.arcTo(e,i+s,e,i,h),t.arcTo(e,i,e+l,i,h),t.closePath(),t.fill()}function J(t,e,i,l,s,h){t.fillStyle="#fff",t.beginPath(),t.arc(e,i,l,0,2*Math.PI),t.fill(),t.strokeStyle="#000",t.lineWidth=1,t.stroke();let a=.4*l,o=e+s*(.3*l),n=i+h*(.3*l);t.fillStyle="#000",t.beginPath(),t.arc(o,n,a,0,2*Math.PI),t.fill(),t.fillStyle="#fff",t.beginPath(),t.arc(o+.3*a,n-.3*a,.3*a,0,2*Math.PI),t.fill()}function Z(t,e,i,l=null){let s=e.cSkin,h=e.cDark,a=e.cSuit,o=2*Math.sin(.5*i),n=Math.sin(.5*i),r=.8*n,c=.8*-n,y=0,p=0;if(l&&l.timer>0){let t=l.timer/l.max,e=Math.sin(t*Math.PI);"kick"===l.type?(r=-Math.PI/2*e,p=10*e,c=Math.PI/4):"punch"===l.type||"shoot"===l.type?(c=-Math.PI/2,y=15*e):"slash"===l.type?c=-Math.PI/2+t*Math.PI-Math.PI/2:"smash_down"===l.type?(c=Math.PI,t<.5&&(c=0)):"throw"===l.type?c=-Math.PI/2+(1-t)*Math.PI:"flex"===l.type&&(c=.5-Math.PI,y=-5,o=3*Math.sin(1.5*i))}let f=["rhino","elephant","bear","poodle","tree"].includes(e.type),d=["rodent","hedgehog","rabbit","pig"].includes(e.type)?.8:f?1.2:1;t.save(),t.scale(d,d),(["dog_pointy","cat","bird"].includes(e.type)||e.name.includes("SUPER")||e.name.includes("THOR")||e.name.includes("STRANGE")||e.name.includes("SCARLET")||e.name.includes("VISION"))&&(t.fillStyle=e.pColor,t.beginPath(),t.moveTo(-10,5+o),t.lineTo(10,5+o),t.lineTo(15+5*Math.sin(.2*i),35+o),t.lineTo(5*Math.sin(.2*i+1)-15,35+o),t.fill()),["dog_pointy","dog_flat","dog_long","cat","fox","wolf","panther","raccoon","monkey","lizard","croc","cow","lion","fish"].includes(e.type)&&(t.strokeStyle=s,t.lineWidth=4,t.lineCap="round",t.beginPath(),t.moveTo(-5,25+o),"monkey"===e.type?t.quadraticCurveTo(-20,10+o,-5,5+o):"fish"===e.type?(t.moveTo(0,25+o),t.lineTo(0,35+o)):t.quadraticCurveTo(-15,20+o+5*Math.sin(.3*i),-20,15+o),t.stroke(),"raccoon"===e.type&&(t.strokeStyle="#333",t.lineWidth=4,t.setLineDash([4,4]),t.stroke(),t.setLineDash([]))),"turtle"===e.type&&(t.fillStyle=h,t.beginPath(),t.arc(0,15+o,14,0,2*Math.PI),t.fill()),t.fillStyle=h,t.save(),t.translate(-4,25+o),t.rotate(r),j(t,-3,0,6,12,3),t.restore(),t.fillStyle=a;let m=f?26:20;j(t,-m/2,8+o,m,f?22:18,5),t.fillStyle="rgba(255,255,255,0.3)",t.beginPath(),t.arc(0,16+o,4,0,2*Math.PI),t.fill(),t.fillStyle="#FFD700",t.fillRect(-m/2,22+o,m,4),t.save(),t.translate(0,0+o),function(t,e){let i=e.cSkin,l=e.cDark;t.fillStyle=i,["dog_pointy","wolf","fox","cat","monkey","bat"].includes(e.type)?(j(t,-12,-12,24,20,8),"monkey"===e.type?(t.beginPath(),t.arc(-14,-5,5,0,2*Math.PI),t.fill(),t.beginPath(),t.arc(14,-5,5,0,2*Math.PI),t.fill()):"bat"===e.type?(t.beginPath(),t.moveTo(-8,-12),t.lineTo(-18,-25),t.lineTo(-2,-12),t.fill(),t.beginPath(),t.moveTo(8,-12),t.lineTo(18,-25),t.lineTo(2,-12),t.fill()):(t.beginPath(),t.moveTo(-8,-10),t.lineTo(-14,-22),t.lineTo(-2,-10),t.fill(),t.beginPath(),t.moveTo(8,-10),t.lineTo(14,-22),t.lineTo(2,-10),t.fill())):["dog_flat","pig","bear","poodle","dog_long","panda","koala","lion"].includes(e.type)?(j(t,-12,-12,24,20,8),t.beginPath(),t.arc(-12,-6,6,0,2*Math.PI),t.fill(),t.beginPath(),t.arc(12,-6,6,0,2*Math.PI),t.fill()):"rabbit"===e.type||"kangaroo"===e.type?(j(t,-10,-10,20,18,5),t.fillStyle=i,j(t,-8,-32,6,24,3),j(t,2,-32,6,24,3)):["rodent","hedgehog","skunk","anteater"].includes(e.type)?(j(t,-10,-8,20,16,6),t.beginPath(),t.arc(-8,-6,4,0,2*Math.PI),t.fill(),t.beginPath(),t.arc(8,-6,4,0,2*Math.PI),t.fill()):["rhino","elephant","cow"].includes(e.type)?(j(t,-14,-14,28,24,8),"cow"===e.type?(t.fillStyle="#fff",t.beginPath(),t.moveTo(-14,-10),t.quadraticCurveTo(-20,-20,-10,-15),t.fill(),t.beginPath(),t.moveTo(14,-10),t.quadraticCurveTo(20,-20,10,-15),t.fill(),t.fillStyle=i):(t.beginPath(),t.arc(-14,-4,8,0,2*Math.PI),t.fill())):["bird","duck","chicken","penguin"].includes(e.type)?(t.beginPath(),t.arc(0,-5,12,0,2*Math.PI),t.fill()):["raccoon","panda"].includes(e.type)?(j(t,-11,-10,22,18,6),t.beginPath(),t.moveTo(-9,-8),t.lineTo(-13,-18),t.lineTo(-3,-8),t.fill(),t.beginPath(),t.moveTo(9,-8),t.lineTo(13,-18),t.lineTo(3,-8),t.fill()):["turtle","frog","fish","alien","skeleton","pumpkin","robot","stone"].includes(e.type)?"turtle"===e.type||"frog"===e.type?(j(t,-12,-10,24,16,8),"frog"===e.type&&(t.beginPath(),t.arc(-8,-12,5,0,2*Math.PI),t.fill(),t.beginPath(),t.arc(8,-12,5,0,2*Math.PI),t.fill())):"fish"===e.type?(t.beginPath(),t.ellipse(0,-5,12,15,Math.PI/2,0,2*Math.PI),t.fill(),t.beginPath(),t.moveTo(0,-18),t.lineTo(-5,-5),t.lineTo(5,-5),t.fill()):"alien"===e.type?(t.beginPath(),t.moveTo(0,10),t.bezierCurveTo(20,0,20,-30,0,-30),t.bezierCurveTo(-20,-30,-20,0,0,10),t.fill()):"skeleton"===e.type?(t.fillStyle="#eee",j(t,-10,-15,20,20,8),t.fillRect(-6,5,12,6)):"pumpkin"===e.type?(t.fillStyle="#FFA500",t.beginPath(),t.arc(0,-5,14,0,2*Math.PI),t.fill(),t.fillStyle="#006400",t.fillRect(-2,-22,4,8)):"robot"===e.type?(j(t,-12,-15,24,24,2),t.beginPath(),t.moveTo(0,-15),t.lineTo(0,-25),t.stroke(),t.beginPath(),t.arc(0,-25,3,0,2*Math.PI),t.fill()):"stone"===e.type&&(t.beginPath(),t.moveTo(-10,-15),t.lineTo(5,-20),t.lineTo(12,-10),t.lineTo(10,5),t.lineTo(-8,8),t.fill()):j(t,-11,-11,22,22,8),"raccoon"!==e.type&&"panda"!==e.type||(t.fillStyle="panda"===e.type?"#000":"#333",t.beginPath(),t.ellipse(-5,-4,4,5,.2,0,2*Math.PI),t.fill(),t.beginPath(),t.ellipse(5,-4,4,5,-.2,0,2*Math.PI),t.fill()),["dog_pointy","dog_flat","dog_long","wolf","fox","bear","pig","monkey","cow"].includes(e.type)?(t.fillStyle=l,"pig"===e.type?(t.fillStyle="#ffb6c1",j(t,-6,0,12,8,3),t.fillStyle="#d16d7e",t.beginPath(),t.arc(-3,4,2,0,2*Math.PI),t.fill(),t.beginPath(),t.arc(3,4,2,0,2*Math.PI),t.fill()):"monkey"===e.type?(t.fillStyle="#FFE4C4",t.beginPath(),t.ellipse(0,2,8,6,0,0,2*Math.PI),t.fill(),t.fillStyle="#000",t.beginPath(),t.moveTo(-2,0),t.lineTo(2,0),t.stroke()):"cow"===e.type?(t.fillStyle="#FFC0CB",j(t,-7,0,14,8,3)):(j(t,-6,-1,12,9,4),t.fillStyle="#000",t.beginPath(),t.arc(0,-1,3,0,2*Math.PI),t.fill())):["cat","panther","raccoon","lion","bat"].includes(e.type)?(t.fillStyle="#000",t.beginPath(),t.moveTo(-2,2),t.lineTo(2,2),t.lineTo(0,5),t.fill(),t.strokeStyle="#000",t.lineWidth=1,t.beginPath(),t.moveTo(5,0),t.lineTo(15,-2),t.stroke(),t.beginPath(),t.moveTo(5,2),t.lineTo(15,4),t.stroke(),t.beginPath(),t.moveTo(-5,0),t.lineTo(-15,-2),t.stroke(),t.beginPath(),t.moveTo(-5,2),t.lineTo(-15,4),t.stroke()):"elephant"===e.type?(t.lineWidth=6,t.strokeStyle=i,t.lineCap="round",t.beginPath(),t.moveTo(0,0),t.quadraticCurveTo(0,15,10,10),t.stroke()):"rhino"===e.type?(t.fillStyle="#eee",t.beginPath(),t.moveTo(0,-5),t.lineTo(4,-15),t.lineTo(6,-5),t.fill()):["bird","duck","chicken","penguin"].includes(e.type)?(t.fillStyle="orange","duck"===e.type||"chicken"===e.type?(t.beginPath(),t.ellipse(0,-2,8,4,0,0,2*Math.PI),t.fill()):(t.beginPath(),t.moveTo(5,-5),t.lineTo(18,-2),t.lineTo(5,2),t.fill())):"anteater"===e.type?(t.fillStyle=l,t.beginPath(),t.moveTo(8,0),t.lineTo(20,2),t.lineTo(8,6),t.fill()):"croc"===e.type||"lizard"===e.type?(t.fillStyle=l,j(t,-8,0,16,12,4)):"skeleton"===e.type?(t.fillStyle="#000",t.beginPath(),t.arc(-5,-6,3,0,2*Math.PI),t.fill(),t.beginPath(),t.arc(5,-6,3,0,2*Math.PI),t.fill(),t.beginPath(),t.moveTo(0,2),t.lineTo(-2,6),t.lineTo(2,6),t.fill()):"pumpkin"===e.type?(t.fillStyle="#000",t.beginPath(),t.moveTo(-6,-6),t.lineTo(-2,-2),t.lineTo(-10,-2),t.fill(),t.beginPath(),t.moveTo(6,-6),t.lineTo(2,-2),t.lineTo(10,-2),t.fill(),t.beginPath(),t.moveTo(-8,5),t.lineTo(0,8),t.lineTo(8,5),t.fill()):"robot"===e.type&&(t.fillStyle="#00FF00",t.fillRect(-8,-10,5,5),t.fillRect(3,-10,5,5),t.fillRect(-6,2,12,2)),["skeleton","pumpkin","robot","alien"].includes(e.type)||(e.name.includes("DARE")?(t.fillStyle=e.cDark,t.fillRect(-12,-8,24,6)):e.name.includes("SPIDER")||e.name.includes("DEAD")||e.name.includes("PANTHER")||e.name.includes("IRON")?(t.fillStyle="#fff",t.beginPath(),t.ellipse(-5,-4,4,6,-.2,0,2*Math.PI),t.fill(),t.beginPath(),t.ellipse(5,-4,4,6,.2,0,2*Math.PI),t.fill(),t.strokeStyle="#000",t.lineWidth=1,t.stroke()):(J(t,-5,-4,4,.5,0),J(t,5,-4,4,.5,0))),(e.name.includes("CAP")||e.name.includes("TRASH"))&&(t.fillStyle=e.cSuit,t.beginPath(),t.arc(0,-11,12,Math.PI,0),t.fill(),t.fillRect(-12,-11,24,2)),"tree"===e.type&&(t.fillStyle="lime",t.beginPath(),t.arc(0,-15,8,0,2*Math.PI),t.fill())}(t,e),t.restore(),t.fillStyle=h,t.save(),t.translate(4+p,25+o+0),l&&"kick"===l.type&&l.timer>0?t.rotate(r):t.rotate(-r),j(t,-3,0,6,12,3),t.restore(),t.fillStyle=a,t.save(),t.translate(0+y,15+o+0),t.rotate(c),j(t,-3,0,6,12,3),t.fillStyle=s,t.beginPath(),t.arc(0,12,4,0,2*Math.PI),t.fill(),"boomerang"===e.pType&&(t.fillStyle=e.pColor,t.translate(0,12),t.rotate(Math.PI/2),t.fillRect(-2,-6,4,12)),t.restore(),t.restore()}class Q{constructor(t,e,i,l,s,h=!1,a=!1,o=!1){this.x=t,this.y=e,this.life=80,this.isSpecial=l,this.w=15,this.h=5,this.color=s.pColor,this.type=s.pType,this.isEnemy=s.isEnemy||!1,this.returnState=0,this.vx=15*i,this.vy=2*(U()-.5),h&&(this.vx=0,this.vy=15,this.w=8,this.h=20),o&&(this.vx=0,this.vy=-15,this.w=8,this.h=20),a&&(this.vx=12*i,this.vy=-5,this.w=12,this.h=12,this.color="#ccc"),h||a||o||("spread"===this.type&&(this.w=8,this.h=8,this.vx=15*i+5*(U()-.5),this.vy=10*(U()-.5)),"rocket"!==this.type&&"grenade"!==this.type||(this.w=12,this.h=12,this.vy=-5),"boomerang"===this.type&&(this.w=20,this.h=20,this.life=100),"bolt"===this.type&&(this.w=25,this.h=10),"laser"===this.type&&(this.w=40,this.h=5,this.vx=25*i),"magic"===this.type&&(this.w=10,this.h=10,this.baseY=e,this.timer=0),"fireball"===this.type&&(this.w=20,this.h=20,this.vx=12*i),"ice_beam"===this.type&&(this.w=30,this.h=6,this.vx=20*i),"sonic_wave"===this.type&&(this.w=10,this.h=40,this.vx=8*i,this.life=120),"lightning"===this.type&&(this.w=50,this.h=4,this.vx=40*i),"shuriken"===this.type&&(this.w=15,this.h=15,this.vx=18*i,this.rotation=0),"water_gun"===this.type&&(this.w=12,this.h=12,this.vx=14*i,this.vy=5*(U()-.5)),"acid_spit"===this.type&&(this.w=10,this.h=10,this.vx=10*i,this.vy=-8),"card_throw"===this.type&&(this.w=12,this.h=4,this.vx=22*i))}update(){if("grenade"===this.type||"rocket"===this.type||"acid_spit"===this.type)this.vy+=.3,this.x+=this.vx,this.y+=this.vy;else if("boomerang"===this.type&&0!==this.vx)if(0===this.returnState)this.x+=this.vx,this.vx*=.95,Math.abs(this.vx)<1&&(this.returnState=1);else{let t=v.x-this.x,e=v.y-this.y,i=Math.atan2(e,t);this.x+=15*Math.cos(i),this.y+=15*Math.sin(i),Math.abs(t)<20&&Math.abs(e)<20&&(this.life=0)}else"magic"===this.type&&0!==this.vx?(this.timer++,this.x+=this.vx,this.y=this.baseY+20*Math.sin(.2*this.timer)):"shuriken"===this.type?(this.x+=this.vx,this.y+=this.vy,this.rotation+=.5):"sonic_wave"===this.type?(this.x+=this.vx,this.w+=.5,this.h+=1,this.y-=.5):(this.x+=this.vx,this.y+=this.vy);this.life--;let t=Math.floor(this.x/l),e=Math.floor(this.y/l);if(e>=0&&e<a&&t>=0&&t<h&&F[e]&&F[e][t]&&0!==F[e][t].type){let i=F[e][t];"sonic_wave"===this.type||1!==i.type&&2!==i.type||("boomerang"===this.type&&0!==this.vx?(this.returnState=1,1===i.type&&(Y(this.x,this.y,r,1),F[e][t]={type:0},L&&L.play("brick_break"))):(Y(this.x,this.y,r,1),this.life=0,1===i.type&&(F[e][t]={type:0},L&&L.play("brick_break")),(this.isSpecial||"rocket"===this.type||"grenade"===this.type||"fireball"===this.type||this.vy>0)&&q(t,e,1)))}if(!this.isEnemy)for(let t=0;t<S.length;t++){let e=S[t];void 0!==e.hp&&e.hp>0&&H(this.x,this.y,this.w,this.h,e.x,e.y,e.w,e.h)&&(e.takeDamage&&e.takeDamage(this.isSpecial?5:1),"boomerang"!==this.type?this.life=0:this.returnState=1)}this.isEnemy&&v&&H(this.x,this.y,this.w,this.h,v.x,v.y,v.w,v.h)&&(v.takeDamage(this.isSpecial?2:1),"boomerang"!==this.type?this.life=0:this.returnState=1)}draw(t,e,i){let l=this.x-e,s=this.y-i;if("boomerang"===this.type)t.save(),t.translate(l,s),t.rotate(.2*Date.now()),t.fillStyle=this.color,t.beginPath(),t.moveTo(0,0),t.lineTo(15,-10),t.lineTo(10,0),t.lineTo(15,10),t.fill(),t.restore();else if("grenade"===this.type||"rocket"===this.type)t.fillStyle="#2ecc71",t.beginPath(),t.arc(l+this.w/2,s+this.h/2,6,0,2*Math.PI),t.fill(),t.fillStyle="#27ae60",t.fillRect(l+this.w/2-2,s-2,4,4);else if("bolt"===this.type||"laser"===this.type||"ice_beam"===this.type||"lightning"===this.type)t.fillStyle=this.color,t.shadowBlur=10,t.shadowColor=this.color,j(t,l,s,this.w,this.h,2),t.shadowBlur=0;else if("fireball"===this.type)t.fillStyle="#FF4500",t.beginPath(),t.arc(l+this.w/2,s+this.h/2,10,0,2*Math.PI),t.fill(),t.fillStyle="#FFFF00",t.beginPath(),t.arc(l+this.w/2,s+this.h/2,6,0,2*Math.PI),t.fill();else if("shuriken"===this.type){t.save(),t.translate(l+this.w/2,s+this.h/2),t.rotate(this.rotation||0),t.fillStyle="#C0C0C0",t.beginPath();for(let e=0;e<4;e++)t.rotate(Math.PI/2),t.moveTo(0,0),t.lineTo(8,0),t.lineTo(2,2),t.lineTo(0,0);t.fill(),t.restore()}else"sonic_wave"===this.type?(t.strokeStyle=this.color,t.lineWidth=2,t.beginPath(),t.arc(l,s+this.h/2,this.h,-Math.PI/4,Math.PI/4),t.stroke(),t.beginPath(),t.arc(l-10,s+this.h/2,this.h-10,-Math.PI/4,Math.PI/4),t.stroke()):"card_throw"===this.type?(t.fillStyle="#fff",t.fillRect(l,s,this.w,this.h),t.fillStyle="red",t.beginPath(),t.arc(l+this.w/2,s+this.h/2,2,0,2*Math.PI),t.fill()):(t.fillStyle=this.color,t.beginPath(),t.arc(l+this.w/2,s+this.h/2,5,0,2*Math.PI),t.fill())}}class tt{constructor(t,e,i,l,s,h=1){this.x=t,this.y=e,this.w=i,this.h=l,this.life=15,this.power=h,this.hp=1,Y(t+i/2,e+l/2,"#fff",.5)}update(){this.life--,this.life<=0&&(this.hp=0),q(Math.floor((this.x+this.w/2)/l),Math.floor((this.y+this.h/2)/l),1);for(let t=0;t<S.length;t++){let e=S[t];e!==this&&void 0!==e.hp&&e.hp>0&&H(this.x,this.y,this.w,this.h,e.x,e.y,e.w,e.h)&&e.takeDamage&&e.takeDamage(2*this.power)}}draw(t,e,i){}takeDamage(){}}class et{constructor(t,e){this.x=t,this.y=e,this.w=l,this.h=l,this.hp=10,this.vx=0,this.vy=0,this.type="prop"}update(){this.vy+=s,this.y+=this.vy;let t=Math.floor((this.y+this.h)/l),e=Math.floor((this.x+this.w/2)/l);t>=0&&t<a&&e>=0&&e<h&&F[t]&&F[t][e]&&0!==F[t][e].type&&(this.y=t*l-this.h,this.vy=0,this.vx*=.8),this.x+=this.vx}takeDamage(t,e){this.hp-=t,this.vx=this.x-e>0?5:-5,this.vy=-5,this.hp<=0&&($(this.x+this.w/2,this.y+this.h/2,2,50),this.x=-9999)}draw(t,e,i){let l=this.x-e,s=this.y-i;t.fillStyle="#e74c3c",j(t,l+5,s+5,this.w-10,this.h-5,5),t.fillStyle="#bdc3c7",t.fillRect(l+12,s,16,5),t.fillStyle="white",t.font="10px Arial",t.fillText("GAS",l+10,s+25)}}class it{constructor(t,e){this.x=t,this.y=e,this.w=l,this.h=l,this.hp=20}update(){}takeDamage(t){this.hp-=t,this.hp<=0&&(this.x=-9999,Y(this.x,this.y,"grey",1))}draw(t,e,i){t.fillStyle="#8e44ad",t.fillRect(this.x-e,this.y-i,this.w,this.h),t.beginPath(),t.moveTo(this.x-e,this.y-i),t.lineTo(this.x-e+this.w,this.y-i+this.h),t.stroke()}}class lt{constructor(t,e){this.x=t,this.y=e,this.w=60,this.h=80,this.occupied=!1,this.hp=500}update(){if(!this.occupied){this.y+=5;let t=Math.floor((this.y+this.h)/l),e=Math.floor((this.x+this.w/2)/l);if(t>=0&&t<a&&e>=0&&e<h&&F[t]&&F[t][e]&&0!==F[t][e].type&&(this.y=t*l-this.h),w)for(let t of w)if(Math.abs(t.x-this.x)<50&&Math.abs(t.y-this.y)<50&&E[t.index].e){this.enter(t);break}}}enter(t){this.occupied=!0,t.inMech=!0,t.mech=this,Y(this.x+30,this.y+40,"cyan",2)}eject(t){this.occupied=!1,t.inMech=!1,t.mech=null,this.x=t.x,this.y=t.y,this.hp=0,Y(this.x+30,this.y+40,"cyan",5),this.x=-9999}draw(t,e,i){if(this.occupied)return;let l=this.x-e,s=this.y-i;t.fillStyle="#34495e",j(t,l,s,this.w,this.h,10),t.fillStyle="#f1c40f",t.fillRect(l+15,s+10,30,20),t.fillStyle="#2c3e50",t.fillRect(l+10,s+60,15,20),t.fillRect(l+35,s+60,15,20),t.fillRect(l-10,s+20,10,30),t.fillRect(l+60,s+20,10,30)}}class st{constructor(t,e){this.x=t,this.y=e,this.w=120,this.h=60,this.timer=0,this.isIntro=t<1e3,this.hp=1e3}update(){if(this.timer++,this.y+=2*Math.sin(.1*this.timer),!this.isIntro&&w)for(let t of w)if(t.health>0&&G(this,t)){g.levelComplete=!0,O();break}this.isIntro&&this.timer>100&&(this.y-=2,this.x-=2,this.y<-200&&(this.x=-9999))}draw(t,e,i){let l=this.x-e,s=this.y-i;t.fillStyle="#27ae60",j(t,l,s,100,50,10),t.fillStyle="rgba(0,0,0,0.5)",t.fillRect(l-20,s-10,140,5),t.fillStyle="#27ae60",t.fillRect(l-40,s+10,40,10),t.fillRect(l-50,s,10,30),t.strokeStyle="#fff",t.beginPath(),t.moveTo(l+50,s+50),t.lineTo(l+50,s+100),t.stroke()}}class ht{constructor(t,e){this.x=t,this.y=e,this.w=60,this.h=40,this.hp=100}update(){this.y+=5;let t=Math.floor((this.y+this.h)/l),e=Math.floor((this.x+this.w/2)/l);t>=0&&t<a&&e>=0&&e<h&&F[t]&&F[t][e]&&0!==F[t][e].type&&(this.y=t*l-this.h)}draw(t,e,i){t.fillStyle="#2c3e50",t.fillRect(this.x-e,this.y-i,this.w,this.h),t.fillStyle="#95a5a6",t.fillRect(this.x-e-2,this.y-i-5,this.w+4,5)}}class at{constructor(t,e){this.x=t,this.y=e,this.w=40,this.h=40,this.freed=!1,this.hp=100}update(){let t=null;if(!this.freed&&w)for(let e of w)if(e.health>0&&G(this,e)){t=e;break}if(t&&(this.freed=!0,Y(this.x,this.y,"green",2),function(t){let e=t?t.x:0,i=t?t.y:0,l=g.rescues+1,s=0===g.globalUnlocked?0:2*g.globalUnlocked-1;l>=s?g.globalUnlocked<u.length?(g.globalUnlocked++,g.unlockedCount=g.globalUnlocked,W(e,i-40,"NEW HERO!","gold"),Y(e,i,"gold",2),L&&L.play("powerup")):W(e,i-40,"MAX ROSTER!","gold"):W(e,i-40,s-l+" MORE","cyan")}(t),g.rescues++,t)){let e=u.slice(0,g.globalUnlocked),i=Math.floor(U()*e.length),l=e[i].id;e.length>1&&l===t.charData.id&&(i=(i+1)%e.length,l=e[i].id),t.setCharacter(l),t.health=3,B(),Y(t.x,t.y,"white",2),W(t.x,t.y-60,"SWITCH!","cyan")}}draw(t,e,i){if(this.freed)return;let l=this.x-e,s=this.y-i;t.strokeStyle="#bdc3c7",t.lineWidth=2,t.strokeRect(l,s,this.w,this.h);for(let e=10;e<this.w;e+=10)t.beginPath(),t.moveTo(l+e,s),t.lineTo(l+e,s+this.h),t.stroke();t.fillStyle="#e67e22",t.beginPath(),t.arc(l+20,s+20,10,0,2*Math.PI),t.fill()}}class ot{constructor(t,e){this.x=t,this.y=e,this.w=40,this.h=60,this.vx=0,this.vy=0,this.hp=3,this.facing=1,this.state="patrol",this.timer=0,this.shootTimer=0,this.color="#e74c3c",this.blockedTimer=0,this.speed=2,this.chaseSpeed=3}update(){this.vy+=s,this.y+=this.vy;let t=Math.floor((this.y+this.h)/l),e=Math.floor((this.x+this.w/2)/l);if(t>=0&&t<a&&e>=0&&e<h&&F[t]&&F[t][e]&&(1===F[t][e].type||2===F[t][e].type)&&(this.y=t*l-this.h,this.vy=0),this.blockedTimer>0)this.blockedTimer--,this.vx=this.facing*this.speed;else{let t=null,e=9999;if(w)for(let i of w)if(i.health>0){let l=Math.hypot(i.x-this.x,i.y-this.y);l<e&&(e=l,t=i)}t&&(this.state=e<400?"chase":"patrol","patrol"===this.state?(this.timer<=0&&(this.timer=60+60*Math.random(),this.facing=Math.random()<.5?-1:1,this.vx=this.facing*this.speed),this.timer--,this.vx=this.facing*this.speed):"chase"===this.state&&(this.facing=t.x<this.x?-1:1,this.vx=this.facing*this.chaseSpeed,this.shootTimer++,this.shootTimer>60&&(this.shoot(t),this.shootTimer=0)))}let i=this.x+this.vx,o=Math.floor(this.y/l),n=Math.floor((this.y+this.h-1)/l),r=Math.floor((i+(this.vx>0?this.w:0))/l),c=!1;if(r>=0&&r<h){let t=F[o]&&F[o][r],e=F[n]&&F[n][r];(t&&(1===t.type||2===t.type)||e&&(1===e.type||2===e.type))&&(c=!0)}else c=!0;let y=Math.floor((i+(this.vx>0?this.w:0))/l),p=Math.floor((this.y+this.h+2)/l),f=!1;if(p<a&&y>=0&&y<h){let t=F[p][y];t&&0!==t.type&&4!==t.type&&6!==t.type||(f=!0)}else f=!0;c||f?(this.vx=0,this.facing*=-1,this.blockedTimer=60):this.x+=this.vx}shoot(t){if(!t)return;let e=Math.atan2(t.y-this.y,t.x-this.x);e+=.2*(Math.random()-.5);let i=new Q(this.x+this.w/2,this.y+20,1,!1,{pColor:this.color,pType:"normal",isEnemy:!0});i.vx=8*Math.cos(e),i.vy=8*Math.sin(e),S.push(i),L&&L.play("enemy_shoot")}takeDamage(t,e){this.hp-=t,W(this.x,this.y,10*t),this.vx=this.x-e>0?5:-5,this.vy=-3,this.blockedTimer=10,this.hp<=0&&(Y(this.x+this.w/2,this.y+this.h/2,"red",1),L&&L.play("explosion"),this.x=-9999)}draw(t,e,i){let l=this.x-e,s=this.y-i,h="#7f8c8d";t.fillStyle="#2c3e50",t.fillRect(l+5,s+40,10,20),t.fillRect(l+25,s+40,10,20),t.fillStyle="#c0392b",t.fillRect(l,s+10,40,30),t.strokeStyle="#000",t.lineWidth=2,t.strokeRect(l,s+10,40,30),t.fillStyle="#fff",t.fillRect(l+2,s+12,2,2),t.fillRect(l+36,s+12,2,2),t.fillRect(l+2,s+36,2,2),t.fillRect(l+36,s+36,2,2),t.fillStyle=h,t.fillRect(l+10,s-5,20,15),t.strokeRect(l+10,s-5,20,15),t.fillStyle="#e74c3c",t.beginPath(),t.arc(l+20+2*this.facing,s+2,4,0,2*Math.PI),t.fill(),t.fillStyle="#fff",t.fillRect(l+20+2*this.facing-1,s+1,2,2),t.fillStyle=h;let a=1===this.facing?l+30:l-10;t.fillRect(a,s+15,20,8),t.fillStyle="#222",t.fillRect(a+(1===this.facing?20:-5),s+12,5,14)}}class nt extends ot{constructor(t,e){super(t,e),this.type="fly",this.hp=2,this.w=40,this.h=40}update(){let t=null,e=9999;if(w)for(let i of w)if(i.health>0){let l=Math.hypot(i.x-this.x,i.y-this.y);l<e&&(e=l,t=i)}if(!t)return;let i=0,s=0;e<500?(i=.02*(t.x-this.x),s=.02*(t.y-this.y-100),this.shootTimer++,this.shootTimer>100&&(this.shoot(t),this.shootTimer=0)):(i*=.9,s=1*Math.sin(.005*Date.now()));let o=this.x+i,n=this.y+s,r=Math.floor((n+this.h/2)/l),c=Math.floor((o+this.w/2)/l);r>=0&&r<a&&c>=0&&c<h&&F[r]&&F[r][c]&&(1===F[r][c].type||2===F[r][c].type)&&(i*=-1.5,s*=-1.5),this.vx+=.1*(i-this.vx),this.vy+=.1*(s-this.vy),this.x+=this.vx,this.y+=this.vy}draw(t,e,i){let l=this.x-e,s=this.y-i;t.fillStyle="rgba(142, 68, 173, 0.6)",t.beginPath(),t.arc(l+20,s+15,15,Math.PI,0),t.fill(),t.strokeStyle="#fff",t.lineWidth=1,t.stroke(),t.fillStyle="#8e44ad",t.beginPath(),t.arc(l+20,s+12,6,0,2*Math.PI),t.fill(),t.fillStyle="#bdc3c7",t.beginPath(),t.ellipse(l+20,s+20,20,8,0,0,2*Math.PI),t.fill(),t.strokeStyle="#7f8c8d",t.stroke();let h=Date.now();for(let e=0;e<3;e++)t.fillStyle=Math.floor(h/200)%3===e?"red":"#550000",t.beginPath(),t.arc(l+10+10*e,s+20,2,0,2*Math.PI),t.fill();t.fillStyle="#333",t.fillRect(l+15,s+25,10,5),Math.random()<.5&&(t.fillStyle="cyan",t.beginPath(),t.moveTo(l+15,s+30),t.lineTo(l+20,s+40),t.lineTo(l+25,s+30),t.fill())}}class rt extends ot{constructor(t,e){super(t,e),this.hp=1,this.speed=4,this.chaseSpeed=5,this.color="#d35400"}update(){super.update();let t=null,e=9999;if(w)for(let i of w)if(i.health>0){let l=Math.hypot(i.x-this.x,i.y-this.y);l<e&&(e=l,t=i)}t&&e<50&&this.explode()}explode(){let t=this.x,e=this.y;this.x=-9999,$(t+20,e+30,2,50)}takeDamage(t,e){super.takeDamage(t,e),this.hp<=0&&this.explode()}draw(t,e,i){let l=this.x-e,s=this.y-i;t.fillStyle="#333",t.fillRect(l+10,s+40,5,20),t.fillRect(l+25,s+40,5,20),t.fillStyle="#2c3e50",t.beginPath(),t.arc(l+20,s+25,18,0,2*Math.PI),t.fill(),t.fillStyle="#7f8c8d",t.fillRect(l+18,s,4,10),Math.random()<.5&&(t.fillStyle="yellow",t.beginPath(),t.arc(l+20,s,4,0,2*Math.PI),t.fill()),t.fillStyle="#000",t.fillRect(l+10,s+20,20,10),t.fillStyle="red",t.font="10px monospace";let h=Math.floor(Date.now()/100)%2==0;t.fillText(h?":(":"X(",l+12,s+28),t.fillStyle=h?"red":"#500",t.beginPath(),t.arc(l+20,s+35,3,0,2*Math.PI),t.fill()}}class ct extends ot{constructor(t,e){super(t,e),this.hp=10,this.w=50,this.h=70,this.color="#27ae60",this.speed=0,this.chaseSpeed=0}update(){this.vy+=s,this.y+=this.vy;let t=Math.floor((this.y+this.h)/l),e=Math.floor((this.x+this.w/2)/l);t>=0&&t<a&&e>=0&&e<h&&F[t]&&F[t][e]&&(1===F[t][e].type||2===F[t][e].type)&&(this.y=t*l-this.h,this.vy=0);let i=null,o=9999;if(w)for(let t of w)if(t.health>0){let e=Math.hypot(t.x-this.x,t.y-this.y);e<o&&(o=e,i=t)}i&&o<500&&(this.facing=i.x<this.x?-1:1,this.shootTimer++,this.shootTimer>10&&(this.shoot(i),this.shootTimer=0))}shoot(t){if(!t)return;let e=Math.atan2(t.y-this.y,t.x-this.x);e+=.4*(Math.random()-.5);let i=new Q(this.x+this.w/2,this.y+30,1,!1,{pColor:this.color,pType:"normal",isEnemy:!0});i.vx=10*Math.cos(e),i.vy=10*Math.sin(e),S.push(i),L&&L.play("enemy_shoot")}draw(t,e,i){let l=this.x-e,s=this.y-i;t.fillStyle="#2c3e50",j(t,l,s+50,50,20,5),t.fillStyle="#7f8c8d";for(let e=0;e<3;e++)t.beginPath(),t.arc(l+10+15*e,s+60,6,0,2*Math.PI),t.fill();t.fillStyle="#27ae60",t.fillRect(l+5,s+10,40,40),t.fillStyle="#1e8449",t.fillRect(l+15,s,20,10),t.fillStyle="#f1c40f",t.fillRect(l+18,s+2,14,4),t.fillStyle="#333";let h=1===this.facing?l+40:l-20;t.fillRect(h,s+25,30,10);let a=2*Math.sin(.5*Date.now());t.fillStyle="#111",t.fillRect(h+(1===this.facing?30:0),s+22+a,5,16)}}class yt extends ot{constructor(t,e){super(t,e),this.hp=2,this.range=800,this.aimTimer=0,this.color="#3498db",this.speed=1,this.chaseSpeed=0,this.target=null}update(){this.vy+=s,this.y+=this.vy;let t=Math.floor((this.y+this.h)/l),e=Math.floor((this.x+this.w/2)/l);t>=0&&t<a&&e>=0&&e<h&&F[t]&&F[t][e]&&(1===F[t][e].type||2===F[t][e].type)&&(this.y=t*l-this.h,this.vy=0);let i=null,o=9999;if(w)for(let t of w)if(t.health>0){let e=Math.abs(t.x-this.x);e<o&&(o=e,i=t)}this.target=i,i&&(o<this.range?(this.facing=i.x<this.x?-1:1,this.aimTimer++,this.aimTimer>180&&(this.shoot(i),this.aimTimer=0)):(this.aimTimer=0,super.update()))}shoot(t){if(!t)return;let e=Math.atan2(t.y-this.y,t.x-this.x),i=new Q(this.x+this.w/2,this.y+20,2,!1,{pColor:this.color,pType:"normal",isEnemy:!0});i.vx=20*Math.cos(e),i.vy=20*Math.sin(e),S.push(i),L&&L.play("enemy_shoot")}draw(t,e,i){let l=this.x-e,s=this.y-i;t.fillStyle="#34495e",t.fillRect(l+15,s+40,4,20),t.fillRect(l+25,s+40,4,20),t.fillStyle="#3498db",t.fillRect(l+15,s+15,14,25),t.fillStyle="#2c3e50",t.beginPath(),t.arc(l+22,s+10,8,0,2*Math.PI),t.fill(),t.fillStyle="#000";let h=l+22+4*this.facing;t.beginPath(),t.arc(h,s+10,4,0,2*Math.PI),t.fill(),t.fillStyle="red",t.beginPath(),t.arc(h,s+10,2,0,2*Math.PI),t.fill(),t.fillStyle="#111";1===this.facing?(t.fillRect(l+20,s+20,40,4),t.fillRect(l+20,s+22,10,6)):(t.fillRect(l+24-40,s+20,40,4),t.fillRect(l+14,s+22,10,6)),this.aimTimer>100&&this.target&&(t.strokeStyle="rgba(231, 76, 60, 0.5)",t.lineWidth=1,t.beginPath(),t.moveTo(l+this.w/2,s+22),t.lineTo(this.target.x-e+this.target.w/2,this.target.y-i+this.target.h/2),t.stroke())}}class pt extends ot{constructor(t,e){super(t,e),this.hp=8,this.shieldUp=!0,this.color="#7f8c8d",this.speed=1,this.chaseSpeed=1}update(){super.update();let t=null,e=9999;if(w)for(let i of w)if(i.health>0){let l=Math.abs(i.x-this.x);l<e&&(e=l,t=i)}t&&(this.shieldUp=t.x<this.x&&-1===this.facing||t.x>this.x&&1===this.facing)}takeDamage(t,e){let i=e<this.x&&-1===this.facing||e>this.x&&1===this.facing;this.shieldUp&&i?(Y(this.x+20,this.y+20,"blue",1),W(this.x,this.y-20,"BLOCKED!","blue"),this.hp-=.1*t):(this.hp-=t,Y(this.x+20,this.y+20,"red",2),W(this.x,this.y,10*t)),this.hp<=0&&(this.x=-9999,Y(this.x,this.y,"red",3),L&&L.play("explosion"))}draw(t,e,i){let l=this.x-e,s=this.y-i;t.fillStyle="#2c3e50",t.fillRect(l+5,s+40,10,20),t.fillRect(l+25,s+40,10,20),t.fillStyle="#95a5a6",t.fillRect(l+5,s+10,30,30),t.fillStyle="#2c3e50",j(t,l+10,s-5,20,15,5),t.fillStyle="cyan",t.fillRect(l+12,s,16,2),t.fillStyle="rgba(52, 152, 219, 0.6)",t.strokeStyle="#fff",t.lineWidth=2;let h=1===this.facing?l+25:l-15;j(t,h,s,30,60,5),t.stroke(),t.fillStyle="white",t.font="10px Arial",t.fillText("POLICE",h+2,s+30)}}class ft extends ot{constructor(t,e){super(t,e),this.hp=15+2*g.currentLevel,this.w=50,this.h=70,this.color="#9b59b6"}update(){this.vy+=s,this.y+=this.vy;let t=Math.floor((this.y+this.h)/l),e=Math.floor((this.x+this.w/2)/l);t>=0&&t<a&&e>=0&&e<h&&F[t]&&F[t][e]&&(1===F[t][e].type||2===F[t][e].type)&&(this.y=t*l-this.h,this.vy=0);let i=null,o=9999;if(w)for(let t of w)if(t.health>0){let e=Math.abs(t.x-this.x);e<o&&(o=e,i=t)}i&&o<600&&(this.facing=i.x<this.x?-1:1)}shootBurst(t){if(t)for(let e=0;e<3;e++)setTimeout(()=>{if(this.hp<=0)return;if(t.health<=0)return;let e=Math.atan2(t.y-this.y,t.x-this.x),i=new Q(this.x+this.w/2,this.y+20,1,!1,{pColor:this.color,pType:"normal",isEnemy:!0});i.vx=12*Math.cos(e),i.vy=12*Math.sin(e),i.color="gold",S.push(i),L&&L.play("enemy_shoot")},100*e)}takeDamage(t,e){if(this.hp-=t,W(this.x,this.y,10*t,"gold"),this.hp<=0){let t=this.x,e=this.y;Y(t+this.w/2,e+this.h/2,"gold",3),L&&L.play("explosion"),this.x=-9999,S.push(new st(t,e-50))}}draw(t,e,i){let l=this.x-e,s=this.y-i;t.fillStyle="#333",j(t,l,s+10,50,50,10),t.fillStyle="#FFE4C4",j(t,l+10,s-10,30,30,8),t.strokeStyle="#111",t.lineWidth=3,t.beginPath(),t.arc(l+25,s-5,18,Math.PI,0),t.stroke(),t.fillStyle="#222",t.fillRect(l+5,s-8,8,12),t.fillRect(l+37,s-8,8,12),t.strokeStyle="#333",t.lineWidth=2,t.beginPath(),t.moveTo(l+37,s),t.lineTo(l+42,s+5),t.lineTo(l+30,s+10),t.stroke(),t.fillStyle="#555",t.beginPath(),t.arc(l+30,s+10,2,0,2*Math.PI),t.fill(),t.fillStyle="#000",t.beginPath(),t.arc(l+20,s,2,0,2*Math.PI),t.fill(),t.beginPath(),t.arc(l+30,s,2,0,2*Math.PI),t.fill(),t.strokeStyle="rgba(0,0,0,0.2)",t.lineWidth=1,t.beginPath(),t.arc(l+20,s+2,3,0,Math.PI),t.stroke(),t.beginPath(),t.arc(l+30,s+2,3,0,Math.PI),t.stroke(),t.fillStyle="#222",t.save(),t.translate(l+25,s+40),t.fillStyle="#FFE4C4",t.beginPath(),t.arc(-10,0,5,0,2*Math.PI),t.fill(),t.beginPath(),t.arc(10,0,5,0,2*Math.PI),t.fill(),t.fillStyle="#444",j(t,-12,-4,24,12,4),t.restore()}}class dt{constructor(t,e){this.x=t,this.y=e,this.w=120,this.h=120,this.hp=50+15*g.currentLevel,this.maxHp=this.hp,this.state="idle",this.timer=0,this.dirY=1}update(){let t=null,e=9999;if(w)for(let i of w)if(i.health>0){let l=Math.abs(i.x-this.x);l<e&&(e=l,t=i)}if(!g.bossActive&&t&&e<800&&(g.bossActive=!0,document.getElementById("bossHealthContainer")&&(document.getElementById("bossHealthContainer").style.display="block")),!g.bossActive)return;this.y+=2*this.dirY,(this.y>2400-this.h-100||this.y<50)&&(this.dirY*=-1),this.timer++;let i=g.currentLevel,l=100;if(i>=5&&(l=80),i>=10&&(l=60),i>=15&&(l=40),this.timer>l){if(!t)return;let e=Math.atan2(t.y-this.y,t.x-this.x),s=8+.2*i,h=new Q(this.x+60,this.y+60,2,!1,{pColor:"#c0392b",pType:"normal",isEnemy:!0});if(h.vx=Math.cos(e)*s,h.vy=Math.sin(e)*s,S.push(h),L&&L.play("enemy_shoot"),i>=3){let t=.2,i=new Q(this.x+60,this.y+60,2,!1,{pColor:"#c0392b",pType:"normal",isEnemy:!0});i.vx=Math.cos(e-t)*s,i.vy=Math.sin(e-t)*s;let l=new Q(this.x+60,this.y+60,2,!1,{pColor:"#c0392b",pType:"normal",isEnemy:!0});l.vx=Math.cos(e+t)*s,l.vy=Math.sin(e+t)*s,S.push(i),S.push(l),L&&L.play("enemy_shoot")}if(i>=6){let t=.4,i=new Q(this.x+60,this.y+60,2,!1,{pColor:"#c0392b",pType:"normal",isEnemy:!0});i.vx=Math.cos(e-t)*s,i.vy=Math.sin(e-t)*s,S.push(i);let l=new Q(this.x+60,this.y+60,2,!1,{pColor:"#c0392b",pType:"normal",isEnemy:!0});l.vx=Math.cos(e+t)*s,l.vy=Math.sin(e+t)*s,S.push(l),L&&L.play("enemy_shoot")}if(i>=10&&this.timer%(2*l)==0){let e=new et(this.x+60,this.y+60);e.vx=.05*(t.x-this.x),e.vy=-5,S.push(e)}this.timer=0}}takeDamage(t,e){if(!g.bossActive)return;this.hp-=t,X(2);let i=this.hp/this.maxHp*100;document.getElementById("bossHealthBar")&&(document.getElementById("bossHealthBar").style.width=i+"%"),W(this.x+60,this.y+60,10*t),this.hp<=0&&(X(50),Y(this.x+60,this.y+60,"#ff00de",5),L&&L.play("explosion"),g.bossActive=!1,document.getElementById("bossHealthContainer")&&(document.getElementById("bossHealthContainer").style.display="none"),S.push(new st(this.x,this.y)),this.x=-9999,g.slowMo=.2,setTimeout(()=>g.slowMo=1,2e3))}draw(t,e,i){if(this.hp<=0)return;let l=this.x-e,s=this.y-i,h=0;this.hp<.5*this.maxHp&&(h=4*(Math.random()-.5)),t.save(),t.translate(l+this.w/2+h,s+this.h/2+h),t.fillStyle="#c0392b",j(t,-40,-50,80,100,10),t.fillStyle="rgba(255,255,255,0.2)",t.fillRect(-30,-40,10,80),t.fillStyle="#222",t.beginPath(),t.arc(-45,45,15,0,2*Math.PI),t.fill(),t.beginPath(),t.arc(45,45,15,0,2*Math.PI),t.fill(),t.fillStyle="#555",t.beginPath(),t.arc(-45,45,5,0,2*Math.PI),t.fill(),t.beginPath(),t.arc(45,45,5,0,2*Math.PI),t.fill(),t.strokeStyle="#333",t.lineWidth=15,t.lineCap="round",t.lineJoin="round",t.beginPath(),t.moveTo(0,-50),t.bezierCurveTo(0,-100,-80,-50,-60,0),t.stroke(),t.fillStyle="#222",t.save(),t.translate(-60,0),t.rotate(.5*Math.sin(.1*this.timer)),t.fillRect(-15,-10,30,40),t.fillStyle="#111",t.fillRect(-20,30,40,10),t.restore(),t.fillStyle="#000",t.beginPath(),t.moveTo(-20,-20),t.lineTo(-5,-10),t.lineTo(-20,0),t.fill(),t.beginPath(),t.moveTo(20,-20),t.lineTo(5,-10),t.lineTo(20,0),t.fill(),t.fillStyle="#222";for(let e=0;e<3;e++)t.fillRect(-15,20+8*e,30,4);t.fillStyle="#fff",t.font="bold 20px Arial",t.fillText("VACUUM KING",-70,-70),t.restore()}}class mt{constructor(t,e){this.x=t,this.y=e,this.w=150,this.h=80,this.hp=200+20*g.currentLevel,this.maxHp=this.hp,this.state="fly",this.timer=0,this.vx=2,this.vy=0,this.targetX=t}update(){let t=null,e=9999;if(w)for(let i of w)if(i.health>0){let l=Math.hypot(i.x-this.x,i.y-this.y);l<e&&(e=l,t=i)}if(!g.bossActive&&t&&e<800&&(g.bossActive=!0,document.getElementById("bossHealthContainer")&&(document.getElementById("bossHealthContainer").style.display="block")),!g.bossActive)return;this.timer++,this.y+=2*Math.sin(.05*this.timer),this.timer%60==0&&t&&(this.targetX=t.x),this.x+=.02*(this.targetX-this.x);let i=g.currentLevel;if(!t)return;if(this.timer%10==0){let e=Math.atan2(t.y-this.y,t.x-this.x);e+=.2*(Math.random()-.5);let i=new Q(this.x+75,this.y+60,1,!1,{pColor:"#f1c40f",pType:"normal",isEnemy:!0});i.vx=15*Math.cos(e),i.vy=15*Math.sin(e),S.push(i),L&&L.play("enemy_shoot")}let l=180;if(i>=10&&(l=120),this.timer%l===0){let e=new et(this.x+75,this.y+80);i>=5&&(e.vx=.05*(t.x-this.x)),S.push(e)}i>=15&&(this.x+=.01*(t.x-this.x))}takeDamage(t,e){if(!g.bossActive)return;this.hp-=t;let i=this.hp/this.maxHp*100;document.getElementById("bossHealthBar")&&(document.getElementById("bossHealthBar").style.width=i+"%"),W(this.x+75,this.y+40,10*t,"cyan"),X(2),this.hp<=0&&(X(100),Y(this.x+75,this.y+40,"orange",10),L&&L.play("explosion"),g.bossActive=!1,document.getElementById("bossHealthContainer")&&(document.getElementById("bossHealthContainer").style.display="none"),this.x=-9999,S.push(new st(15400,320)),g.slowMo=.1,setTimeout(()=>g.slowMo=1,3e3))}draw(t,e,i){if(this.hp<=0)return;let l=this.x-e,s=this.y-i;t.fillStyle="#2f4f4f",j(t,l,s,140,70,20),t.fillStyle="#3498db",t.beginPath(),t.moveTo(l+10,s+20),t.lineTo(l+40,s+20),t.lineTo(l+40,s+50),t.lineTo(l+15,s+50),t.fill(),t.fillStyle="#000",t.fillRect(l+60,s-10,20,10),t.fillStyle="rgba(0,0,0,0.5)",t.fillRect(l-20,s-15,180,5),t.fillStyle="#111",t.fillRect(l+60,s+70,30,10),this.timer%10<5&&(t.fillStyle="yellow",t.beginPath(),t.arc(l+75,s+85,10,0,2*Math.PI),t.fill()),t.fillStyle="#111",t.fillRect(l+80,s+20,40,30)}}function ut(){e.setTransform(1,0,0,1,0,0),e.clearRect(0,0,t.width,t.height);var i=e.createLinearGradient(0,0,0,t.height);i.addColorStop(0,"#111"),i.addColorStop(1,"#333"),e.fillStyle=i,e.fillRect(0,0,t.width,t.height)}function gt(){e.setTransform(1,0,0,1,0,0),e.clearRect(0,0,t.width,t.height);var i=e.createLinearGradient(0,0,0,t.height);i.addColorStop(0,"#111"),i.addColorStop(1,"#333"),e.fillStyle=i,e.fillRect(0,0,t.width,t.height);let l=840,s=(t.width-l)/2+35,h=1;l>t.width&&(h=t.width/890),e.save(),e.scale(h,h),h<1&&(s=(t.width/h-l)/2+35),e.font="30px 'Courier New'",e.fillStyle="#00ff41",e.textAlign="center",e.fillText("ROSTER STATUS: "+g.globalUnlocked+" / "+u.length+" HEROES UNLOCKED",t.width/h/2,50);for(let t=0;t<u.length;t++){let i=s+70*(t%12),l=100+70*Math.floor(t/12);if(e.fillStyle="rgba(255,255,255,0.1)",j(e,i-30,l-30,60,60,10),t<g.globalUnlocked){e.save(),e.translate(i,l),e.scale(.8,.8);let s=Date.now()/100;Z(e,u[t],s),e.restore(),e.fillStyle="#aaa",e.font="8px Arial",e.fillText(u[t].name.split(" ")[0],i,l+40)}else{e.fillStyle="#222",e.beginPath(),e.arc(i,l,15,0,2*Math.PI),e.fill();let s=(0===t?0:2*t-1)-g.rescues;s<0&&(s=0),e.fillStyle="#555",t===g.globalUnlocked?(e.font="10px Arial",e.fillText("NEXT",i,l-5),e.font="bold 16px Arial",e.fillStyle="#00ff41",e.fillText(s,i,l+12)):(e.font="10px Arial",e.fillText("NEED",i,l-5),e.font="16px Arial",e.fillText(s,i,l+12))}}e.restore()}function Ft(){let i=(U()-.5)*g.shake,s=(U()-.5)*g.shake;e.setTransform(1,0,0,1,0,0),e.clearRect(0,0,t.width,t.height),function(t){let e=t.createLinearGradient(0,0,0,t.canvas.height);e.addColorStop(0,f),e.addColorStop(1,d),t.fillStyle=e,t.fillRect(0,0,t.canvas.width,t.canvas.height),t.fillStyle="rgba(255, 255, 255, 0.1)",t.beginPath(),t.arc(t.canvas.width-100,100,50,0,2*Math.PI),t.fill()}(e),e.save(),e.scale(g.zoom,g.zoom),e.translate(-g.cameraX+i,-g.cameraY+s);let o=Math.floor(g.cameraX/l),u=o+t.width/g.zoom/l+4,v=Math.floor(g.cameraY/l),b=v+t.height/g.zoom/l+4;for(let t=v;t<b&&t<a;t++)for(let i=o;i<u&&i<h;i++)if(F&&F[t]&&F[t][i]&&0!==F[t][i].type){let s=F[t][i],h=i*l,a=t*l;if(6===s.type){e.fillStyle=m,e.fillRect(h+10,a,5,l),e.fillRect(h+25,a,5,l);for(let t=0;t<4;t++)e.fillRect(h+10,a+10*t+2,20,4)}else if(5===s.type)e.fillStyle=s.active?"#00ff41":"#555",e.shadowBlur=20,e.shadowColor=e.fillStyle,e.fillRect(h+15,a+10,5,30),e.beginPath(),e.moveTo(h+20,a+10),e.lineTo(h+35,a+15),e.lineTo(h+20,a+20),e.fill(),e.shadowBlur=0,e.fillStyle="#333",e.fillRect(h+5,a+35,30,5);else if(4===s.type)if("#e74c3c"===s.color)e.fillStyle=s.color,e.fillRect(h,a+10,l,30),e.fillStyle="orange",e.beginPath(),e.arc(h+40*U(),a+10,5,0,2*Math.PI),e.fill();else{let t=e.createLinearGradient(h,a,h,a+l);t.addColorStop(0,"#ccc"),t.addColorStop(1,"#555"),e.fillStyle=t,e.beginPath(),e.moveTo(h,a+l),e.lineTo(h+10,a),e.lineTo(h+20,a+l),e.lineTo(h+30,a),e.lineTo(h+40,a+l),e.fill()}else if(1===s.type){let s=n;"city"===g.levelData.biome&&(s="#333"),"volcano"===g.levelData.biome&&(s="#422"),e.fillStyle=s,e.fillRect(h,a,l,l),"city"===g.levelData.biome?(e.fillStyle="#444",e.fillRect(h,a+35,40,5)):(e.fillStyle=r,e.fillRect(h+5,a+5,10,10),e.fillRect(h+25,a+20,8,8)),t>0&&0===F[t-1][i].type&&("city"===g.levelData.biome?e.fillStyle="#555":"volcano"===g.levelData.biome?e.fillStyle="#722":e.fillStyle=c,e.fillRect(h,a,l,8))}else if(2===s.type){let t=y;"city"===g.levelData.biome&&(t="#222"),e.fillStyle=t,e.fillRect(h,a,l,l),e.strokeStyle=p,e.lineWidth=2,e.beginPath(),e.moveTo(h,a+20),e.lineTo(h+l,a+20),e.stroke()}else 9===s.type&&(e.fillStyle="gold",e.shadowBlur=30,e.shadowColor="gold",e.fillRect(h,a,l,l),e.shadowBlur=0,e.fillStyle="#000",e.font="10px Arial",e.fillText("VAN",h+5,a+25))}T.forEach(t=>t.draw(e)),S.forEach(t=>t.draw(e,0,0)),w&&w.forEach(t=>{t.health>0&&t.draw(e,0,0)}),x.forEach(t=>t.draw(e)),e.font="900 20px 'Segoe UI'",e.lineWidth=3,k.forEach(t=>{e.fillStyle=t.color,e.strokeStyle="black",e.strokeText(t.text,t.x,t.y),e.fillText(t.text,t.x,t.y)}),e.restore();var E=e.createRadialGradient(t.width/2,t.height/2,200,t.width/2,t.height/2,600);E.addColorStop(0,"transparent"),E.addColorStop(1,"rgba(0,0,0,0.6)"),e.fillStyle=E,e.fillRect(0,0,t.width,t.height)}class St{constructor(t=0){this.index=t,this.reset(),this.charData=u[t%u.length]}setCharacter(t){this.charData=u.find(e=>e.id===t)||u[0],0===this.index&&B()}reset(){this.x=g.spawnPoint.x+20*this.index,this.y=g.spawnPoint.y,this.w=24,this.h=30,this.vx=0,this.vy=0,this.speed=5,this.grounded=!1,this.facing=1,this.health=3,this.invincible=0,this.stretchX=1,this.stretchY=1,this.animFrame=0,this.lastY=this.y,this.secondaryCooldown=0,this.shootCooldown=0,this.specialCooldown=0,this.attackAnim={type:null,timer:0,max:0},this.wallJumpLocked=!1}respawn(){if(g.lives--,B(),g.lives<=0)return g.running=!1,document.getElementById("ovTitle").innerText="MISSION FAILED",document.getElementById("ovTitle").style.color="red",document.getElementById("ovMsg").innerText="Out of lives. The pound awaits.",void(document.getElementById("gameOverOverlay").style.display="flex");let t=u.slice(0,g.globalUnlocked),e=Math.floor(U()*t.length);this.setCharacter(t[e].id),this.x=g.spawnPoint.x,this.y=g.spawnPoint.y-40,this.vx=0,this.vy=0,this.health=3,this.invincible=120,Y(this.x,this.y,"#00ff41",2),L&&L.play("powerup")}checkWall(t){if(!F)return!1;let e=t>0?this.x+this.w+2:this.x-2,i=[this.y,this.y+this.h/2,this.y+this.h-1];for(let t of i){let i=Math.floor(t/l),s=Math.floor(e/l);if(i>=0&&i<a&&s>=0&&s<h&&F[i]&&F[i][s]&&(1===F[i][s].type||2===F[i][s].type))return!0}return!1}update(){this.lastY=this.y,this.secondaryCooldown>0&&this.secondaryCooldown--,this.attackAnim.timer>0&&this.attackAnim.timer--;let t=E[this.index]||{};if(t.f)return this.vx=0,this.attackAnim={type:"flex",timer:10,max:10},g.frame%10==0&&(W(this.x,this.y-20,"FLEX!","gold"),X(2)),this.vy+=s,this.y+=this.vy,void this.checkCollisions(!1);let e=Math.floor((this.x+this.w/2)/l),i=Math.floor((this.y+this.h/2)/l),o=i>=0&&i<a&&e>=0&&e<h&&F[i]&&F[i][e]&&6===F[i][e].type,n=0;(t.arrowleft||t.a)&&(n=-1),(t.arrowright||t.d)&&(n=1),(t.c||t.v)&&this.secondaryCooldown<=0&&(this.performSecondary(),this.secondaryCooldown=30);let c=t.shift;this.speed=c?9:5;let y=0;this.checkWall(-1)&&(y=-1),this.checkWall(1)&&(y=1);let p=!1;if(!this.grounded&&0!==y&&n===y&&this.vy>0&&(p=!0,this.vy>2&&(this.vy=2),t[" "]&&!this.wallJumpLocked&&(this.vy=-13,L&&L.play("jump"),this.vx=10*-y,this.wallJumpLocked=!0,this.facing=-y,Y(this.x+(y>0?this.w:0),this.y+this.h/2,r,.5),p=!1)),t[" "]||(this.wallJumpLocked=!1),o){if(this.vy=0,0!==n)this.vx=3*n;else{let t=e*l+(l-this.w)/2;this.vx=.2*(t-this.x)}(t.arrowup||t.w)&&(this.vy=-3),(t.arrowdown||t.s)&&(this.vy=3),t[" "]&&(this.vy=-13,L&&L.play("jump"))}else{if(!this.wallJumpLocked){if(0!==n){this.vx+=.8*n,this.facing=n,this.animFrame+=c?2:1;let t=c?5:10;this.grounded&&this.animFrame%t===0&&x.push(new V(this.x+15,this.y+30,"#d2b48c"))}else this.vx*=.85,this.animFrame=0;Math.abs(this.vx)>this.speed&&(this.vx=Math.sign(this.vx)*this.speed)}t[" "]&&this.grounded&&!p&&(this.vy=-13,this.grounded=!1,this.stretchX=.7,this.stretchY=1.3,L&&L.play("jump")),this.vy+=s,this.vy>15&&(this.vy=15)}if(p&&g.frame%5==0&&x.push(new V(this.x+(y>0?this.w:0),this.y+this.h,"#fff")),this.shootCooldown>0&&this.shootCooldown--,this.specialCooldown>0&&this.specialCooldown--,(t.z||t.j)&&this.shootCooldown<=0){let e=t.arrowdown||t.s,i=t.arrowup||t.w;this.shoot(!1,e,i),this.shootCooldown=15}(t.x||t.k)&&this.specialCooldown<=0&&(this.shoot(!0,!1),this.specialCooldown=120),this.x+=this.vx,this.checkCollisions(!0),this.y+=this.vy,this.checkCollisions(!1),this.stretchX+=.1*(1-this.stretchX),this.stretchY+=.1*(1-this.stretchY),this.invincible>0&&this.invincible--,this.y>2600&&this.takeDamage(99)}checkCollisions(t){if(!F)return;let e=Math.floor(this.x/l),i=Math.floor((this.x+this.w-.01)/l),s=Math.floor(this.y/l),o=Math.floor((this.y+this.h-.01)/l);for(let n=s;n<=o;n++)for(let s=e;s<=i;s++)if(n>=0&&n<a&&s>=0&&s<h&&F[n]&&F[n][s]&&0!==F[n][s].type){let e=F[n][s].type;if(6===e)continue;if(4===e)return void this.takeDamage();if(9===e)return void O();if(5===e){F[n][s].active||(F[n][s].active=!0,g.checkpointsHit++,g.spawnPoint={x:s*l,y:n*l-40},Y(s*l+20,n*l+20,"#00ff41",2),this.health<3&&(this.health=3),B());continue}if(1===e||2===e)if(t)this.vx>0?(this.x=s*l-this.w,this.vx=0):this.vx<0&&(this.x=s*l+l,this.vx=0);else if(this.vy>0){if(this.lastY+this.h<=n*l+15)return this.y=n*l-this.h,this.vy=0,this.grounded||(this.stretchX=1.4,this.stretchY=.6),void(this.grounded=!0)}else if(this.vy<0)return this.y=n*l+l,void(this.vy=0)}}takeDamage(t=1){this.invincible>0||(this.health-=t,X(15),this.invincible=60,Y(this.x,this.y,"red"),L&&L.play("hurt"),this.health<=0&&this.respawn(),B())}performSecondary(){let t=this.charData.pType;"melee_slash"===t||"melee_smash"===t?(S.push(new Q(this.x+15*this.facing,this.y+10,this.facing,!1,this.charData,!1,!0)),this.attackAnim={type:"throw",timer:15,max:15}):(S.push(new tt(this.x+(1===this.facing?0:-40),this.y,40,40,this,1)),x.push(new V(this.x+20*this.facing,this.y+10,"white")),this.attackAnim={type:"kick",timer:15,max:15})}shoot(t,e,i=!1){x.push(new V(this.x+30*this.facing,this.y+10,"yellow")),X(2),L&&L.play("shoot");let l=this.charData.pType;if(t)if(this.attackAnim={type:"punch",timer:15,max:15},X(10),"raccoon"===this.charData.id)S.push(new ht(this.x,this.y-100));else if("spread"===l)for(let t=0;t<16;t++){let e=t/16*Math.PI*2,i=new Q(this.x+15,this.y+15,this.facing,!0,this.charData);i.vx=15*Math.cos(e),i.vy=15*Math.sin(e),S.push(i)}else if("grenade"===l||"rocket"===l)for(let t=0;t<3;t++){let e=new Q(this.x+15+15*this.facing,this.y+15,this.facing,!0,this.charData);e.vy=-5-3*t,e.vx=this.facing*(10+2*t),S.push(e)}else if("melee_smash"===l)S.push(new tt(this.x-100,this.y,200+this.w,60,this,5)),Y(this.x,this.y+30,"white",3),X(20);else{let t=new Q(this.x+15+15*this.facing,this.y+15,this.facing,!0,this.charData);t.w=30,t.h=10,t.vx=30*this.facing,S.push(t),this.vx-=20*this.facing}else{if(e)return void("melee_slash"===l||"melee_smash"===l?(S.push(new tt(this.x,this.y+this.h,this.w,40,this,2)),this.vy=-5,this.attackAnim={type:"smash_down",timer:20,max:20}):(S.push(new Q(this.x+this.w/2-5,this.y+this.h,this.facing,t,this.charData,!0)),this.vy=-2));if(i)return void("melee_slash"===l||"melee_smash"===l?(S.push(new tt(this.x,this.y-40,this.w,40,this,2)),this.attackAnim={type:"slash",timer:15,max:15}):S.push(new Q(this.x+this.w/2-5,this.y-20,this.facing,t,this.charData,!1,!1,!0)));if("melee_slash"===l||"melee_smash"===l||"smash"===l){let t="melee_smash"===l?80:50,e="melee_smash"===l?3:2;S.push(new tt(this.x+(1===this.facing?0:-t),this.y,t,40,this,e)),this.attackAnim={type:"slash",timer:15,max:15}}else if("spread"===l){for(let t=0;t<3;t++){let t=new Q(this.x+15*this.facing,this.y+10,this.facing,!1,this.charData);t.vy=5*(U()-.5),S.push(t)}this.attackAnim={type:"shoot",timer:10,max:10}}else if("shuriken"===l){for(let t=0;t<3;t++){let e=new Q(this.x+15*this.facing,this.y+10,this.facing,!1,this.charData);e.vy=2*(t-1),S.push(e)}this.attackAnim={type:"throw",timer:10,max:10}}else if("water_gun"===l){for(let t=0;t<4;t++){let t=new Q(this.x+15*this.facing,this.y+10,this.facing,!1,this.charData);t.vx=this.facing*(12+4*U()),t.vy=6*(U()-.5),S.push(t)}this.attackAnim={type:"shoot",timer:10,max:10}}else S.push(new Q(this.x+15+15*this.facing,this.y+15,this.facing,!1,this.charData)),this.attackAnim={type:"shoot",timer:10,max:10};this.vx-=2*this.facing}}draw(t,e,i){if(this.invincible>0&&Math.floor(g.frame/4)%2==0)return;let l=this.x-e+this.w/2,s=this.y-i+this.h/2+this.h*(1-this.stretchY);t.save(),t.translate(l,s),t.scale(this.facing*this.stretchX,this.stretchY),t.fillStyle="rgba(0,0,0,0.5)",t.beginPath(),t.ellipse(0,15,20,5,0,0,2*Math.PI),t.fill(),t.translate(0,-22),Z(t,this.charData,this.animFrame,this.attackAnim),t.restore()}}function xt(){console.log("INIT() CALLED"),R(0),L.initialized,window.addEventListener("resize",kt),kt();const t=document.getElementById("soundToggle");if(t){let e=t.cloneNode(!0);t.parentNode.replaceChild(e,t),e.addEventListener("click",t=>{if(t.preventDefault(),t.stopPropagation(),L){const t=L.toggleMute();e.innerText=t?"üîá":"üîä",L.init()}}),L&&(e.innerText=L.muted?"üîá":"üîä")}g.screen="MENU",g.running=!1,g.currentLevel=1,document.getElementById("menuOverlay").style.display="flex",document.getElementById("rosterOverlay").style.display="none",document.getElementById("lobbyOverlay")&&(document.getElementById("lobbyOverlay").style.display="none"),document.getElementById("gameUI").style.display="none",document.getElementById("bossHealthContainer").style.display="none",document.getElementById("gameOverOverlay").style.display="none",document.getElementById("levelCompleteOverlay").style.display="none"}function kt(){t&&(t.width=window.innerWidth,t.height=window.innerHeight,"MENU"===g.screen&&ut(),"ROSTER"===g.screen&&gt())}function Tt(){let t=0;for(let e=0;e<4;e++){let i=document.getElementById("lobbyStatus"+(e+1));if(i)if(_[e]){let l="keyboard"===_[e].type?"KEYBOARD":`GAMEPAD ${_[e].index+1}`;i.innerText="READY\n("+l+")",i.style.color="#00ff41",t++}else i.innerText="PRESS A / SPACE",i.style.color="#777"}let e=document.getElementById("lobbyStartBtn");e&&(t>0?(e.style.display="block",document.getElementById("lobbyMessage").innerText=`${t} PLAYER(S) READY`):(e.style.display="none",document.getElementById("lobbyMessage").innerText="WAITING FOR PLAYERS..."))}window.enterLobby=function(){g.screen="LOBBY",document.getElementById("menuOverlay").style.display="none",document.getElementById("lobbyOverlay").style.display="flex";for(let t=0;t<4;t++)_[t]=null;Tt()},window.lobbyLoop=function(){if("LOBBY"!==g.screen)return;(playerKeys[0][" "]||playerKeys[0].enter)&&(_[0]||(_[0]={type:"keyboard"}));const t=navigator.getGamepads?navigator.getGamepads():[];for(let e=0;e<t.length;e++){let i=t[e];if(i&&(i.buttons[0]&&i.buttons[0].pressed||i.buttons[9]&&i.buttons[9].pressed)){if(!_.find(t=>t&&"gamepad"===t.type&&t.index===i.index)){let t=_.findIndex(t=>null===t);-1!==t&&(_[t]={type:"gamepad",index:i.index})}}}Tt()},window.startGame=function(){console.log("STARTGAME() CALLED");try{t=function(){let t=[],e=[],i=g.currentLevel,s="forest";i>=3&&(s="city"),i>=5&&(s="volcano"),g.levelData.biome=s,g.levelData.difficulty=i;let h=200;i>=2&&(h=250),i>=3&&(h=300),i>=4&&(h=350),i>=5&&(h=400),g.levelData.width=h;let o=h,n=!1;function r(t,s,h=!1){let a=U();if((h||a<.15)&&!n&&!(s>20))return e.push(new ft(t*l,s*l)),n=!0,void(i>=5?(e.push(new pt((t-1)*l,s*l)),e.push(new pt((t+1)*l,s*l))):i>=3?(e.push(new pt((t-1)*l,s*l)),e.push(new ot((t+1)*l,s*l))):(e.push(new ot((t-1)*l,s*l)),e.push(new ot((t+1)*l,s*l))));i>=5&&a<.25?(e.push(new pt(t*l,s*l)),e.push(new ot((t-1)*l,s*l)),e.push(new ot((t+1)*l,s*l))):i>=7&&a<.35?(e.push(new ct(t*l,(s-1)*l)),e.push(new pt((t+2)*l,s*l))):i>=3&&a<.45?(e.push(new rt(t*l,s*l)),e.push(new rt((t+1)*l,s*l)),e.push(new rt((t-1)*l,s*l))):(e.push(new ot(t*l,s*l)),i>=2?(e.push(new ot((t+1)*l,s*l)),U()<.5&&e.push(new ot((t-1)*l,s*l))):U()<.3&&e.push(new ot((t+1)*l,s*l)))}for(let e=0;e<a;e++)t[e]=new Array(o).fill(null).map(()=>({type:0}));let c=10,y=Math.floor(o/6),p=0,f=0,d=-60,m=0,u=[];for(let h=0;h<o;h++){if(i>=20&&h>o-40){if(c=12,h===o-40)for(let e=0;e<15;e++)12-e>0&&(t[12-e][h]={type:2})}else if(h>15){let o=i<=2?.1:.2+.05*i;U()<o&&(c+=U()>.5?-1:1),c<6&&(c=6),c>50&&(c=50);let n=1===i?0:.005+.01*i;if(U()<n&&h>20){for(let e=0;e<a;e++)e>=0&&e<a&&(t[e][h]={type:0});t[59][h]="volcano"===s?{type:4,color:"#e74c3c"}:{type:4,color:"#999"},u[h]=70,U()<.5&&e.push(new it(h*l,(c-1)*l));continue}if(f<8&&h-d>30&&U()<.08){let t=c-1;t>0&&(e.push(new at(h*l,t*l)),f++,d=h,r(h+2,t))}}else c=10;u[h]=c;for(let e=0;e<a;e++)if(e>=c){let l=1;(h<15||i>=20&&h>o-40||e>=58)&&(l=2),t[e][h]={type:l}}}for(let s=40;s<o-60;s+=40)if(U()<.7&&u[s]<45){let h=u[s],n=55;for(let e=h;e<n;e++)e>=0&&e<a&&(t[e][s]={type:6});let r=Math.floor(3*U())+2;for(let c=0;c<r;c++){let r=h+10+Math.floor(U()*(n-h-15)),c=10+Math.floor(15*U()),y=U()>.5?1:-1;for(let h=0;h<c;h++){let n=s+h*y;for(let e=r;e<r+3;e++)e>=0&&e<a&&n>=0&&n<o&&(t[e][n]={type:0});if(U()<.1&&h>5&&h%5==0){let t=U();i>=3&&t<.3?e.push(new rt(n*l,(r+2)*l)):e.push(new ot(n*l,(r+2)*l))}if(f<8&&(n-d>30||d-n>30)&&U()<.05){let s=r;s>0&&0!==t[s-1][n].type&&(t[s-1][n]={type:1},e.push(new at(n*l,(s+1)*l,s-1,n)),f++,d=n,i>=5?e.push(new ct((n+2)*l,(s+1)*l)):e.push(new ot((n+2)*l,(s+1)*l)))}}}}p=0,y=Math.floor(o/6),m=20;for(let s=20;s<o-40;s++){let h=u[s];if(h>=a)continue;let c=p<5;i>=5&&p>=3&&(c=!1),s>=y&&c?(t[h][s]={type:2},t[h-1][s]={type:5,active:!1,id:p},y+=Math.floor(o/(i>=5?4:6)),p++,i>=3&&U()<.3&&e.push(new lt((s+2)*l,(h-3)*l))):U()<.03+.01*i&&0===t[h-1][s].type&&e.push(new et(s*l,(h-1)*l));let f=30-i;f<12&&(f=12);let d=s>o-60;if(s-m>f||d&&!n){let t=d&&!n?1:.4;U()<t&&(r(s,h-1,d&&!n),m=s)}U()<.02&&i>=3&&e.push(new yt(s*l,(h-1)*l)),U()<.02&&i>=2&&e.push(new nt(s*l,(h-5)*l))}for(let e=0;e<a;e++)t[e][0]={type:2},t[e][o-1]={type:2};if(i>=10&&i%5==0)if(i>=20)e.push(new dt((o-20)*l,320)),e.push(new ct((o-35)*l,320)),e.push(new ct((o-5)*l,320));else{let t=Math.floor(.7*o),s=t+Math.floor(U()*(o-t-5)),h=10;u[s]&&(h=u[s]-5),h>55&&(h=10),"heli"==(i>=14&&i%2==0?"heli":"ground")?e.push(new mt(s*l,(h-10)*l)):e.push(new dt(s*l,h*l)),r(s-5,h),r(s+5,h)}return C(e),t}(),F=t,console.log("LEVEL GENERATED. TILES:",F.length),D([]),A([]),M([]),g.checkpointsHit=0,"MENU"!==g.screen&&"LOBBY"!==g.screen||(g.score=0,g.rescues=0,g.lives=3,g.currentLevel=1),g.bossActive=!1,g.screen="GAME",g.running=!0,P([]),I(null);let e=_.map((t,e)=>({config:t,slot:e})).filter(t=>null!==t.config);0===e.length&&(console.log("No inputs configured, defaulting P1 to Keyboard"),_[0]={type:"keyboard"},e=[{config:{type:"keyboard"},slot:0}]);let i=[];e.forEach((t,e)=>{let l=new St(t.slot),s=Math.min(g.globalUnlocked,u.length),h=(Math.floor(U()*s)+e)%s;l.setCharacter(u[h].id),i.push(l)}),P(i),I(w[0]);let s=80,h=80,o=new st(s,h);S.push(o),w.forEach((t,e)=>{t.x=s+20+10*e,t.y=h+60,t.vy=5,Y(t.x,t.y,"#fff",1)}),g.spawnPoint={x:s+20,y:h+60},document.getElementById("menuOverlay").style.display="none",document.getElementById("lobbyOverlay")&&(document.getElementById("lobbyOverlay").style.display="none"),document.getElementById("gameUI").style.display="flex",document.getElementById("levelCompleteOverlay").style.display="none",B(),R(0)}catch(t){console.error("Error starting game:",t),g.screen="MENU",document.getElementById("menuOverlay").style.display="flex",document.getElementById("gameUI").style.display="none"}var t},window.nextLevel=function(){g.currentLevel++,g.score+=1e3,window.startGame()},window.returnToBase=function(){xt()},window.resetGame=function(){window.startGame()},window.viewRoster=function(){g.screen="ROSTER",document.getElementById("menuOverlay").style.display="none",document.getElementById("rosterOverlay").style.display="flex"},window.returnToMenu=function(){g.screen="MENU",document.getElementById("rosterOverlay").style.display="none",document.getElementById("menuOverlay").style.display="flex"},window.onerror=function(t,e,i,l,s){console.error("Global Error:",t,"at",i,":",l);const h=document.getElementById("errorOverlay");h&&(h.style.display="block",h.innerHTML+=`<div><strong>Error:</strong> ${t} <br><small>${e}:${i}</small></div><hr>`)},window.addEventListener("keydown",t=>{let e=_.findIndex(t=>t&&"keyboard"===t.type);-1===e?E[0][t.key.toLowerCase()]=!0:E[e][t.key.toLowerCase()]=!0}),window.addEventListener("keyup",t=>{let e=_.findIndex(t=>t&&"keyboard"===t.type);-1!==e?E[e][t.key.toLowerCase()]=!1:E[0][t.key.toLowerCase()]=!1}),function(){const t={btnUp:"arrowup",btnDown:"arrowdown",btnLeft:"arrowleft",btnRight:"arrowright",btnJump:" ",btnShoot:"z",btnSpecial:"x",btnSecondary:"c",btnFlex:"f"};function e(t,e){E[0][t]!==e&&(E[0][t]=e)}function i(i,l){const s=document.getElementById(i);if(!s)return;if("btnSprint"===i)return void(l&&(E[0].shift=!E[0].shift,E[0].shift?s.classList.add("active"):s.classList.remove("active")));const h=t[i];h&&(e(h,l),l?s.classList.add("active"):s.classList.remove("active"))}Object.keys(t).concat(["btnSprint"]).forEach(t=>{const e=document.getElementById(t);if(!e)return;const l=e=>{e.preventDefault(),i(t,!0)},s=e=>{e.preventDefault(),i(t,!1)};e.addEventListener("touchstart",l,{passive:!1}),e.addEventListener("touchend",s,{passive:!1}),e.addEventListener("mousedown",l),e.addEventListener("mouseup",s),e.addEventListener("mouseleave",s)});const l=document.getElementById("controlsToggle"),s=document.getElementById("touchControls");function h(){"none"===s.style.display?l.style.opacity="0.5":l.style.opacity="1"}l&&s&&(l.addEventListener("click",t=>{t.preventDefault(),"none"===s.style.display?s.style.display="flex":s.style.display="none",h()}),"ontouchstart"in window||navigator.maxTouchPoints>0?s.style.display="flex":s.style.display="none",h())}(),xt(),requestAnimationFrame(function e(l){b||R(l);const s=l-b;let h=o/g.slowMo;if(s<h)requestAnimationFrame(e);else{R(l-s%h),function(){const t=navigator.getGamepads?navigator.getGamepads():[];for(let e=0;e<t.length;e++){let i=t[e];if(!i)continue;let l=_.findIndex(t=>t&&"gamepad"===t.type&&t.index===i.index);if(-1===l)continue;let s=E[l],h=N[l];if(!s||!h)continue;const a=(t,e)=>{i.buttons[t]&&i.buttons[t].pressed?(s[e]=!0,h[e]=!0):h[e]&&(s[e]=!1,h[e]=!1)};a(0," "),a(1,"x"),a(2,"z"),a(3,"c"),a(4,"shift"),a(5,"shift"),a(12,"arrowup"),a(13,"arrowdown"),a(14,"arrowleft"),a(15,"arrowright");const o=.5;let n=i.axes[0],r=n<-o;n>o?(s.arrowright=!0,h.stick_x=1):r?(s.arrowleft=!0,h.stick_x=-1):h.stick_x&&(s.arrowright=!1,s.arrowleft=!1,h.stick_x=0);let c=i.axes[1],y=c<-o;c>o?(s.arrowdown=!0,h.stick_y=1):y?(s.arrowup=!0,h.stick_y=-1):h.stick_y&&(s.arrowdown=!1,s.arrowup=!1,h.stick_y=0),a(9,"f")}}();try{i&&(i.textContent=`State: ${g.screen}\nRun: ${g.running}\nLevel: ${g.currentLevel}\nBiome: ${g.levelData.biome}\nEnts: ${S.length}\nFPS: ${Math.round(1e3/s)}`)}catch(t){}try{if("MENU"===g.screen);else if("ROSTER"===g.screen);else if("LOBBY"===g.screen)window.lobbyLoop();else if(g.running){g.hitStop>0?g.hitStop--:(g.frame++,w&&w.forEach(t=>{t.health>0&&t.update()}),C(S.filter(t=>t.hp>0||t.life>0)),S.forEach(t=>t.update()),D(x.filter(t=>t.life>0)),x.forEach(t=>t.update()),A(k.filter(t=>t.life>0)),k.forEach(t=>{t.y+=t.vy,t.life--}),M(T.filter(t=>t.life>0)),T.forEach(t=>t.update()));let e=w.filter(t=>t.health>0);if(e.length>0){let i=1/0,l=-1/0,s=1/0,h=-1/0;e.forEach(t=>{t.x<i&&(i=t.x),t.x+t.w>l&&(l=t.x+t.w),t.y<s&&(s=t.y),t.y+t.h>h&&(h=t.y+t.h)});const a=200,o=150,n=Math.max(t.width,l-i+a),r=Math.max(t.height,h-s+o);let c=Math.min(t.width/n,t.height/r);c=Math.max(.5,Math.min(1,c)),g.zoom+=.05*(c-g.zoom);let y=(i+l)/2,p=(s+h)/2,f=t.width/g.zoom,d=t.height/g.zoom,m=y-.5*f,u=p-.5*d;if(m<0&&(m=0),g.bossActive){let t=15e3;m<t&&(m=t)}u<0&&(u=0),g.cameraX+=.1*(m-g.cameraX),g.cameraY+=.1*(u-g.cameraY)}U(),g.shake,U(),g.shake;g.shake*=.9}}catch(t){console.error("Game Loop Update Error:",t)}try{"MENU"===g.screen?ut():"ROSTER"===g.screen?gt():"LOBBY"!==g.screen&&("GAME"===g.screen||g.running)&&Ft()}catch(t){console.error("Game Loop Draw Error:",t)}requestAnimationFrame(e)}})}();
//# sourceMappingURL=game.bundle.js.map

</script>


</body>
</html>
